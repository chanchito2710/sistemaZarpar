# ü§ñ INSTRUCCIONES PARA EL AGENTE IA - SISTEMA ZARPAR

> **‚ö†Ô∏è LEER OBLIGATORIAMENTE AL INICIO DE CADA CONVERSACI√ìN**

---

## üì¶ INSTALACI√ìN DESDE CERO (Para Nueva M√°quina)

### üéØ OBJETIVO
Levantar el proyecto completo en una m√°quina nueva desde el repositorio de GitHub, incluyendo Docker, MySQL, frontend y backend.

---

### ‚úÖ PREREQUISITOS

#### 1. Sistema Operativo
- **Windows 10/11** (64-bit)
- **macOS** (Intel o Apple Silicon)
- **Linux** (Ubuntu 20.04+ o similar)

#### 2. Software a Instalar
- Node.js 18.x o superior
- Docker Desktop
- Git
- Editor de c√≥digo (VS Code recomendado)

---

### üöÄ PASO A PASO: INSTALACI√ìN COMPLETA

#### **PASO 1: Instalar Node.js**

##### Windows:
1. Ir a: https://nodejs.org/
2. Descargar el instalador LTS (Long Term Support)
3. Ejecutar el instalador y seguir los pasos
4. Verificar instalaci√≥n:
   ```bash
   node --version    # Debe mostrar v18.x.x o superior
   npm --version     # Debe mostrar 9.x.x o superior
   ```

##### macOS:
```bash
# Usando Homebrew (recomendado)
brew install node@18

# Verificar
node --version
npm --version
```

##### Linux (Ubuntu/Debian):
```bash
# Instalar Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verificar
node --version
npm --version
```

---

#### **PASO 2: Instalar Docker Desktop**

##### Windows:
1. **Requisitos previos:**
   - Windows 10/11 Pro, Enterprise, o Education (con Hyper-V)
   - O Windows 10/11 Home (con WSL 2)
   - Virtualizaci√≥n habilitada en BIOS

2. **Descargar Docker Desktop:**
   - Ir a: https://www.docker.com/products/docker-desktop/
   - Descargar "Docker Desktop for Windows"
   - Ejecutar el instalador `Docker Desktop Installer.exe`

3. **Configuraci√≥n inicial:**
   - Durante la instalaci√≥n, marcar "Use WSL 2 instead of Hyper-V"
   - Reiniciar la computadora cuando se solicite

4. **Iniciar Docker Desktop:**
   - Abrir "Docker Desktop" desde el men√∫ inicio
   - Esperar a que el √≠cono en la barra de tareas muestre "Docker Desktop is running"
   - Aceptar los t√©rminos de servicio

5. **Verificar instalaci√≥n:**
   ```bash
   docker --version          # Debe mostrar Docker version 24.x.x
   docker compose version    # Debe mostrar Docker Compose version v2.x.x
   ```

##### macOS:
1. **Descargar Docker Desktop:**
   - Ir a: https://www.docker.com/products/docker-desktop/
   - Descargar "Docker Desktop for Mac" (Intel o Apple Silicon seg√∫n tu Mac)

2. **Instalar:**
   - Abrir el archivo `.dmg` descargado
   - Arrastrar Docker a la carpeta Aplicaciones
   - Abrir Docker desde Aplicaciones
   - Dar permisos de administrador cuando se solicite

3. **Verificar:**
   ```bash
   docker --version
   docker compose version
   ```

##### Linux (Ubuntu):
```bash
# Actualizar paquetes
sudo apt-get update

# Instalar dependencias
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Agregar clave GPG oficial de Docker
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# Configurar repositorio
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Instalar Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Agregar usuario al grupo docker (para usar sin sudo)
sudo usermod -aG docker $USER

# Reiniciar sesi√≥n o ejecutar:
newgrp docker

# Verificar
docker --version
docker compose version
```

---

#### **PASO 3: Instalar Git**

##### Windows:
1. Descargar desde: https://git-scm.com/download/win
2. Ejecutar el instalador
3. Configuraci√≥n recomendada durante instalaci√≥n:
   - Editor: VS Code (o el que prefieras)
   - PATH: "Git from the command line and also from 3rd-party software"
   - Line endings: "Checkout Windows-style, commit Unix-style"

4. Verificar:
   ```bash
   git --version
   ```

##### macOS:
```bash
# Git suele venir preinstalado, si no:
brew install git

# Verificar
git --version
```

##### Linux:
```bash
sudo apt-get install git

# Verificar
git --version
```

---

#### **PASO 4: Clonar el Repositorio**

```bash
# Navegar a la carpeta donde quieres el proyecto
cd ~/Desktop  # O la ruta que prefieras

# Clonar el repositorio (reemplaza con tu URL de GitHub)
git clone https://github.com/TU_USUARIO/sistema-zarpar.git

# Entrar al directorio
cd sistema-zarpar

# Verificar que tienes todos los archivos
ls -la  # En Windows: dir
```

---

#### **PASO 5: Configurar Variables de Entorno**

```bash
# Crear archivo .env en la ra√≠z del proyecto
# En Windows PowerShell:
New-Item .env -ItemType File

# En macOS/Linux:
touch .env
```

**Contenido del archivo `.env`:**
```env
# Base de Datos (MySQL en Docker)
DB_HOST=localhost
DB_PORT=3307
DB_USER=root
DB_PASSWORD=zarpar2025
DB_NAME=zarparDataBase

# Backend
PORT=3456

# JWT Secret (para autenticaci√≥n)
JWT_SECRET=tu_secreto_super_seguro_cambialo_en_produccion_zarpar2025

# Frontend (Vite)
VITE_API_URL=http://localhost:3456/api
```

**‚ö†Ô∏è IMPORTANTE:** Cambia `JWT_SECRET` por una cadena aleatoria segura en producci√≥n.

---

#### **PASO 6: Levantar MySQL con Docker**

```bash
# Asegurarse de que Docker Desktop est√° corriendo
docker ps  # Debe responder sin errores

# Crear y levantar el contenedor de MySQL
docker run -d \
  --name zarpar-mysql \
  -e MYSQL_ROOT_PASSWORD=zarpar2025 \
  -e MYSQL_DATABASE=zarparDataBase \
  -p 3307:3306 \
  --restart unless-stopped \
  mysql:8.0

# Verificar que el contenedor est√° corriendo
docker ps | grep zarpar-mysql

# Ver logs del contenedor (opcional)
docker logs zarpar-mysql
```

**En Windows PowerShell, el comando es:**
```powershell
docker run -d `
  --name zarpar-mysql `
  -e MYSQL_ROOT_PASSWORD=zarpar2025 `
  -e MYSQL_DATABASE=zarparDataBase `
  -p 3307:3306 `
  --restart unless-stopped `
  mysql:8.0
```

**Esperar 20-30 segundos** para que MySQL termine de inicializarse.

---

#### **PASO 7: Restaurar la Base de Datos**

```bash
# Importar el backup completo a la base de datos
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 < database/backup_completo.sql

# Verificar que se import√≥ correctamente
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 -e "USE zarparDataBase; SHOW TABLES;"
```

**Deber√≠as ver tablas como:**
- `categorias_productos`
- `clientes_maldonado`
- `clientes_pando`
- `clientes_rivera`
- `productos`
- `productos_sucursal`
- `vendedores`
- ... y m√°s

---

#### **PASO 8: Instalar Dependencias del Proyecto**

```bash
# Instalar todas las dependencias de Node.js
npm install

# Esto instalar√°:
# - Dependencias del frontend (React, Vite, Ant Design, etc.)
# - Dependencias del backend (Express, MySQL2, JWT, etc.)
# - Herramientas de desarrollo (TypeScript, ESLint, etc.)
```

**‚è±Ô∏è Este paso puede tardar 2-5 minutos** dependiendo de tu conexi√≥n a internet.

---

#### **PASO 9: Levantar el Proyecto**

##### Opci√≥n A: Usando el script autom√°tico (Windows)

```bash
# Ejecutar el archivo START.bat
./START.bat
```

Este script levanta autom√°ticamente:
- Frontend en puerto `5678`
- Backend en puerto `3456`

##### Opci√≥n B: Manual (Para ver logs separados)

**Terminal 1 - Backend:**
```bash
npm run dev:api
```

**Terminal 2 - Frontend:**
```bash
npm run dev
```

##### Opci√≥n C: Usando PowerShell Scripts (Windows)

```powershell
# Backend
./start-backend.ps1

# Frontend (en otra terminal)
./start-frontend.ps1
```

---

#### **PASO 10: Verificar que Todo Funciona**

1. **Frontend:** Abrir navegador en http://localhost:5678
   - Deber√≠as ver la p√°gina de login del Sistema Zarpar

2. **Backend:** Verificar en http://localhost:3456/api
   - Deber√≠as ver un mensaje JSON

3. **Base de Datos:** Verificar conexi√≥n
   ```bash
   docker exec -i zarpar-mysql mysql -u root -pzarpar2025 -e "SELECT COUNT(*) as total_vendedores FROM zarparDataBase.vendedores;"
   ```

---

#### **PASO 11: Iniciar Sesi√≥n**

**Credenciales disponibles:**

| Usuario | Email | Contrase√±a | Permisos |
|---------|-------|------------|----------|
| **Administrador** | admin@zarparuy.com | admin123 | ‚úÖ Acceso total a todas las sucursales |
| Pando | pando@zarparuy.com | pando123 | ‚ùå Solo sucursal Pando |
| Maldonado | maldonado@zarparuy.com | maldonado123 | ‚ùå Solo sucursal Maldonado |
| Rivera | rivera@zarparuy.com | rivera123 | ‚ùå Solo sucursal Rivera |
| Melo | melo@zarparuy.com | melo123 | ‚ùå Solo sucursal Melo |
| Paysand√∫ | paysandu@zarparuy.com | paysandu123 | ‚ùå Solo sucursal Paysand√∫ |
| Salto | salto@zarparuy.com | salto123 | ‚ùå Solo sucursal Salto |
| Tacuaremb√≥ | tacuarembo@zarparuy.com | tacuarembo123 | ‚ùå Solo sucursal Tacuaremb√≥ |

**Recomendaci√≥n:** Usa `admin@zarparuy.com` / `admin123` para tener acceso completo.

---

### üîß SOLUCI√ìN DE PROBLEMAS COMUNES

#### ‚ùå Error: "Docker daemon is not running"
**Soluci√≥n:**
- Abrir Docker Desktop manualmente
- Esperar a que el √≠cono muestre "Docker Desktop is running"
- Reintentar el comando

#### ‚ùå Error: "Port 3307 is already in use"
**Soluci√≥n:**
```bash
# Ver qu√© proceso usa el puerto
# Windows:
netstat -ano | findstr :3307

# macOS/Linux:
lsof -i :3307

# Opci√≥n 1: Detener el otro contenedor
docker stop $(docker ps -q --filter "publish=3307")

# Opci√≥n 2: Usar otro puerto (cambiar en .env y docker run)
```

#### ‚ùå Error: "Cannot connect to MySQL"
**Soluci√≥n:**
```bash
# Verificar que el contenedor est√° corriendo
docker ps | grep zarpar-mysql

# Ver logs para errores
docker logs zarpar-mysql

# Reiniciar contenedor
docker restart zarpar-mysql

# Esperar 30 segundos y reintentar
```

#### ‚ùå Error: "Module not found" o errores de TypeScript
**Soluci√≥n:**
```bash
# Limpiar cache y reinstalar
rm -rf node_modules package-lock.json
npm install

# En Windows:
Remove-Item -Recurse -Force node_modules, package-lock.json
npm install
```

#### ‚ùå Error: "EACCES: permission denied" (Linux/macOS)
**Soluci√≥n:**
```bash
# Cambiar permisos del directorio
sudo chown -R $USER:$USER .

# O usar npm con usuario actual
npm config set prefix ~/.npm-global
export PATH=~/.npm-global/bin:$PATH
```

---

### üìã CHECKLIST DE VERIFICACI√ìN

Antes de considerar que el proyecto est√° completamente instalado:

```
[ ] Node.js instalado (v18+)
[ ] Docker Desktop instalado y corriendo
[ ] Git instalado
[ ] Repositorio clonado
[ ] Archivo .env creado con las variables correctas
[ ] Contenedor MySQL corriendo (docker ps muestra zarpar-mysql)
[ ] Base de datos importada (SHOW TABLES muestra tablas)
[ ] Dependencias instaladas (node_modules existe)
[ ] Backend corriendo en http://localhost:3456
[ ] Frontend corriendo en http://localhost:5678
[ ] Login funciona con admin@zarparuy.com / admin123
[ ] Puedes navegar por el sistema sin errores
```

---

### üéì COMANDOS √öTILES DE MANTENIMIENTO

#### Reiniciar todo el sistema
```bash
# Detener todo
docker stop zarpar-mysql
# Matar procesos de Node (Ctrl+C en las terminales)

# Iniciar todo de nuevo
docker start zarpar-mysql
npm run dev
```

#### Ver logs del backend
```bash
# Los logs se muestran en la terminal donde ejecutaste npm run dev:api
```

#### Ver logs de MySQL
```bash
docker logs zarpar-mysql
docker logs -f zarpar-mysql  # Seguir logs en tiempo real
```

#### Hacer backup de la base de datos
```bash
docker exec zarpar-mysql mysqldump -u root -pzarpar2025 zarparDataBase > backup_$(date +%Y%m%d).sql
```

#### Restaurar un backup
```bash
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 zarparDataBase < backup_20251029.sql
```

#### Actualizar el proyecto desde GitHub
```bash
git pull origin main
npm install  # Por si hay nuevas dependencias
```

---

### üåê URLS DEL SISTEMA

| Servicio | URL | Descripci√≥n |
|----------|-----|-------------|
| **Frontend** | http://localhost:5678 | Interfaz de usuario principal |
| **Login** | http://localhost:5678/login | P√°gina de inicio de sesi√≥n |
| **Dashboard** | http://localhost:5678/dashboard | Panel principal |
| **POS** | http://localhost:5678/pos | Punto de Venta |
| **Productos** | http://localhost:5678/products | Gesti√≥n de productos |
| **Admin DB** | http://localhost:5678/admin/database | Administrador de base de datos |
| **Backend API** | http://localhost:3456/api | API REST del backend |
| **MySQL** | localhost:3307 | Base de datos (usar MySQL Workbench o similar) |

---

### üìö DOCUMENTACI√ìN ADICIONAL

Archivos de documentaci√≥n incluidos en el proyecto:

- `CONTEXTO_AGENTE.md` ‚Üí **Este archivo** - Contexto completo para el agente IA
- `COMO_FUNCIONA_PRODUCTOS_EXPLICACION_VISUAL.md` ‚Üí C√≥mo funciona el sistema de productos
- `ANALISIS_ESTRUCTURA_PRODUCTOS_Y_STOCK.md` ‚Üí An√°lisis de la base de datos
- `README.md` ‚Üí Documentaci√≥n general del proyecto

---

## üéØ REGLA #1: BASE DE DATOS - NUNCA CAMBIAR

### üê≥ MySQL con Docker

**IMPORTANTE:** Este proyecto usa **Docker** para MySQL.

#### Informaci√≥n del Contenedor:
```
Nombre del contenedor: zarpar-mysql
Imagen: mysql:8.0
Puerto expuesto: 3307 (host) ‚Üí 3306 (contenedor)
```

#### Verificar que Docker est√° corriendo:
```bash
# Ver contenedores activos
docker ps

# Deber√≠as ver algo como:
# CONTAINER ID   IMAGE        PORTS                    NAMES
# fd8027103378   mysql:8.0    3307:3306/tcp           zarpar-mysql
```

#### Si el contenedor NO est√° corriendo:
```bash
# Iniciar el contenedor
docker start zarpar-mysql

# O iniciarlo y ver logs
docker start zarpar-mysql && docker logs -f zarpar-mysql
```

### Conexi√≥n MySQL
```env
DB_HOST=localhost
DB_PORT=3307
DB_USER=root
DB_PASSWORD=zarpar2025
DB_NAME=zarparDataBase
```

### Comandos para Levantar el Proyecto
```bash
# 1. PRIMERO: Aseg√∫rate de que Docker Desktop est√° corriendo
# 2. SEGUNDO: Verifica que el contenedor zarpar-mysql est√° activo (docker ps)
# 3. TERCERO: Inicia el proyecto

npm run dev

# Frontend: http://localhost:5678
# Backend: http://localhost:3456
# MySQL: localhost:3307 (Docker)
```

### üîß Comandos √∫tiles de Docker para MySQL

```bash
# Ver logs del contenedor MySQL
docker logs zarpar-mysql

# Acceder a MySQL desde terminal (dentro del contenedor)
docker exec -it zarpar-mysql mysql -u root -pzarpar2025

# Ver el estado del contenedor
docker ps -a | grep zarpar-mysql

# Reiniciar el contenedor (si hay problemas)
docker restart zarpar-mysql

# Ejecutar SQL desde archivo
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 zarparDataBase < archivo.sql
```

### ‚ö†Ô∏è NUNCA, BAJO NINGUNA CIRCUNSTANCIA:
- ‚ùå Cambiar el puerto `5678` del frontend
- ‚ùå Cambiar el puerto `3456` del backend
- ‚ùå Cambiar el puerto `3307` de MySQL (Docker)
- ‚ùå Modificar las credenciales de la base de datos
- ‚ùå Crear una nueva base de datos
- ‚ùå Cambiar el nombre `zarparDataBase`
- ‚ùå Detener o eliminar el contenedor `zarpar-mysql` sin backup
- ‚ùå Cambiar el nombre del contenedor Docker

---

## üîç REGLA #2: ANTES DE HACER CUALQUIER CAMBIO

### Proceso OBLIGATORIO:

1. **LEER** todos los archivos relacionados
2. **REVISAR** todas las funciones que usan la base de datos
3. **IDENTIFICAR** qu√© componentes se ver√°n afectados
4. **VERIFICAR** que no romper√°s nada existente
5. **PLANIFICAR** el cambio sin afectar c√≥digo funcional
6. **APLICAR** el cambio
7. **PROBAR** que todo sigue funcionando
8. **VERIFICAR** linter errors

### Archivos Cr√≠ticos a Revisar SIEMPRE:
```
api/config/database.ts          # Configuraci√≥n DB
api/controllers/*                # Todos los controladores
api/routes/*                     # Todas las rutas
src/services/api.ts             # Servicios de frontend
src/pages/admin/DatabaseManager.tsx  # Admin de BD
```

### Si Algo se Rompe:
1. **DETENTE** inmediatamente
2. **REVIERTE** el cambio
3. **ANALIZA** el problema
4. **PROP√ìN** una soluci√≥n alternativa al usuario
5. **ESPERA** aprobaci√≥n antes de continuar

---

## üåç REGLA #3: TODO EN ESPA√ëOL

### Aplicar en:
- ‚úÖ Comentarios de c√≥digo
- ‚úÖ Nombres de variables (cuando sea l√≥gico)
- ‚úÖ Nombres de funciones descriptivas
- ‚úÖ Mensajes de error y √©xito
- ‚úÖ Documentaci√≥n
- ‚úÖ Interfaces de usuario
- ‚úÖ Logs de consola
- ‚úÖ Respuestas al usuario

### Ejemplo de C√≥digo:
```typescript
// ‚úÖ CORRECTO
const cargarClientes = async () => {
  try {
    const respuesta = await obtenerClientesPorSucursal(sucursal);
    mensaje.success('Clientes cargados exitosamente');
  } catch (error) {
    mensaje.error('Error al cargar los clientes');
  }
};

// ‚ùå INCORRECTO (mezclar idiomas)
const loadClientes = async () => {
  const response = await getClientesPorSucursal(branch);
}
```

---

## üë®‚Äçüéì REGLA #4: EL USUARIO ES PRINCIPIANTE

### Tratar al Usuario Como:
- üéì Estudiante que est√° aprendiendo
- üÜï Principiante en programaci√≥n
- üìö Alguien que quiere entender el "por qu√©"

### SIEMPRE Hacer:
1. **EXPLICAR** cada cambio que hagas
2. **ENSE√ëAR** el concepto detr√°s del c√≥digo
3. **SIMPLIFICAR** t√©rminos t√©cnicos
4. **USAR** analog√≠as del mundo real
5. **SUGERIR** mejoras y buenas pr√°cticas
6. **ANTICIPAR** problemas futuros
7. **DOCUMENTAR** con comentarios claros

### Ejemplo de Respuesta:
```
‚ùå MAL: "Agregu√© un useEffect con dependencies array"

‚úÖ BIEN: 
"Agregu√© un useEffect (una funci√≥n que se ejecuta autom√°ticamente 
cuando carga el componente). Esto es como tener un ayudante que 
siempre verifica si algo cambi√≥ y actualiza la informaci√≥n. 
En este caso, cada vez que cambies de sucursal, autom√°ticamente 
traer√° los clientes de esa sucursal."
```

### Actuar Como:
- üí° **Ingeniero Senior** que revisa y optimiza el c√≥digo
- üéØ **Mentor** que ense√±a y explica
- üîç **QA Tester** que encuentra posibles problemas
- üèóÔ∏è **Arquitecto** que sugiere mejores soluciones

---

## üè¢ REGLA #5: SISTEMA DE SUCURSALES Y ROLES

### üëë USUARIO ADMINISTRADOR (ACCESO TOTAL)

**‚≠ê √öNICO USUARIO CON ACCESO A TODO:**

| Rol              | Email                | Acceso                           | Sucursal      |
|------------------|----------------------|----------------------------------|---------------|
| **Administrador**| admin@zarparuy.com   | TODAS las tablas de clientes     | Administracion|
|                  |                      | TODAS las sucursales             |               |
|                  |                      | Vendedores de todas las sucursales|              |

**Caracter√≠sticas del Admin:**
- ‚úÖ Puede ver `clientes_pando`, `clientes_maldonado`, `clientes_rivera`, etc. (TODAS)
- ‚úÖ Puede gestionar vendedores de cualquier sucursal
- ‚úÖ Tiene permisos de lectura/escritura en toda la base de datos
- ‚úÖ Puede generar reportes consolidados de todas las sucursales
- ‚úÖ Es el √öNICO usuario con estos privilegios
- ‚úÖ Est√° en la tabla `vendedores` con cargo "Administrador" o "Director General"
- ‚úÖ **PRODUCTOS**: Puede crear, editar, actualizar stock y precios en `/products`
- ‚úÖ **PRODUCTOS**: Ve botones de acciones (editar, actualizar stock/precio)

### ‚ö†Ô∏è IMPORTANTE: "ADMINISTRADOR" NO ES UNA SUCURSAL

**üö® REGLA CR√çTICA:**

| Concepto | Descripci√≥n | Uso |
|----------|-------------|-----|
| **"Administrador"** | Es un ROL, NO una sucursal f√≠sica | ‚ùå NO usar en selectores de sucursales |
| | Es el puesto del gerente general | ‚ùå NO tiene tabla de clientes |
| | Tiene acceso a TODAS las sucursales | ‚úÖ Puede seleccionar cualquier sucursal real |
| | Email: admin@zarparuy.com | ‚úÖ Se identifica por email, no por sucursal |

**En c√≥digo, SIEMPRE:**
```typescript
// ‚ùå MAL - Tratar "Administrador" como sucursal
const sucursales = ['Pando', 'Maldonado', 'Administrador'];

// ‚úÖ BIEN - Filtrar "Administrador" de las sucursales
const sucursales = ['Pando', 'Maldonado', 'Rivera', ...].filter(
  s => s.toLowerCase() !== 'administrador'
);

// ‚úÖ BIEN - Identificar admin por email, no por sucursal
if (usuario.email === 'admin@zarparuy.com') {
  // Dar acceso a todas las sucursales
}
```

**Cuando listar sucursales:**
- ‚ùå NO incluir "Administrador", "Administracion", "Admin"
- ‚úÖ SOLO listar sucursales f√≠sicas: Pando, Maldonado, Rivera, Melo, Paysand√∫, Salto, Tacuaremb√≥
- ‚úÖ El admin puede SELECCIONAR entre estas sucursales, pero su rol no es una de ellas

### üë• USUARIOS POR SUCURSAL (ACCESO LIMITADO)

**7 Sucursales con acceso restringido:**

| Sucursal    | Email                    | Tabla de Clientes       | Acceso                    |
|-------------|--------------------------|-------------------------|---------------------------|
| Pando       | pando@zarparuy.com       | clientes_pando          | SOLO Pando                |
| Maldonado   | maldonado@zarparuy.com   | clientes_maldonado      | SOLO Maldonado            |
| Rivera      | rivera@zarparuy.com      | clientes_rivera         | SOLO Rivera               |
| Melo        | melo@zarparuy.com        | clientes_melo           | SOLO Melo                 |
| Paysand√∫    | paysandu@zarparuy.com    | clientes_paysandu       | SOLO Paysand√∫             |
| Salto       | salto@zarparuy.com       | clientes_salto          | SOLO Salto                |
| Tacuaremb√≥  | tacuarembo@zarparuy.com  | clientes_tacuarembo     | SOLO Tacuaremb√≥           |

**Restricciones de Usuarios de Sucursal:**
- ‚ùå **PRODUCTOS**: NO pueden crear productos en `/products`
- ‚ùå **PRODUCTOS**: NO pueden editar productos
- ‚ùå **PRODUCTOS**: NO pueden actualizar stock ni precios
- ‚úÖ **PRODUCTOS**: SOLO pueden VER productos (modo lectura)
- ‚ùå **PRODUCTOS**: NO ven botones de acciones (sin editar, sin actualizar stock/precio)

### Reglas de Relaci√≥n:

#### 1. Usuario ‚Üí Sucursal ‚Üí Clientes

**üî¥ CASO ESPECIAL - ADMINISTRADOR:**
```
admin@zarparuy.com ‚Üí TODAS las sucursales ‚Üí TODAS las tablas de clientes
‚îú‚îÄ clientes_pando
‚îú‚îÄ clientes_maldonado
‚îú‚îÄ clientes_rivera
‚îú‚îÄ clientes_melo
‚îú‚îÄ clientes_paysandu
‚îú‚îÄ clientes_salto
‚îî‚îÄ clientes_tacuarembo
```

**üü¢ CASO NORMAL - USUARIOS POR SUCURSAL (1:1):**
- Cada email est√° asociado a UNA sucursal espec√≠fica
- `pando@zarparuy.com` ‚Üí SOLO puede acceder a sucursal Pando ‚Üí SOLO `clientes_pando`
- `maldonado@zarparuy.com` ‚Üí SOLO puede acceder a sucursal Maldonado ‚Üí SOLO `clientes_maldonado`
- Y as√≠ sucesivamente...

#### 2. Sucursal ‚Üí Clientes (1:N)
- Cada sucursal tiene su PROPIA tabla de clientes
- Los clientes de Pando est√°n en `clientes_pando`
- Los clientes de Maldonado est√°n en `clientes_maldonado`
- **EXCEPCI√ìN**: Admin ve todas las tablas de clientes

#### 3. Sucursal ‚Üí Vendedores (1:N)
- Cada sucursal tiene sus propios vendedores
- Los vendedores est√°n en la tabla `vendedores`
- Filtrados por el campo `sucursal`
- **EXCEPCI√ìN**: Admin puede ver vendedores de todas las sucursales

### Mapeo Autom√°tico (SIEMPRE APLICAR):

```typescript
// Funci√≥n de mapeo que SIEMPRE debes usar
const obtenerTablaClientes = (
  sucursal: string, 
  email?: string
): string | string[] => {
  
  // ‚≠ê CASO ESPECIAL: Administrador puede ver TODAS
  if (email === 'admin@zarparuy.com') {
    return [
      'clientes_pando',
      'clientes_maldonado',
      'clientes_rivera',
      'clientes_melo',
      'clientes_paysandu',
      'clientes_salto',
      'clientes_tacuarembo'
    ];
  }
  
  // üîπ CASO NORMAL: Mapeo por sucursal
  const mapeo = {
    'pando': 'clientes_pando',
    'maldonado': 'clientes_maldonado',
    'rivera': 'clientes_rivera',
    'melo': 'clientes_melo',
    'paysandu': 'clientes_paysandu',
    'salto': 'clientes_salto',
    'tacuarembo': 'clientes_tacuarembo'
  };
  return mapeo[sucursal.toLowerCase()] || 'clientes_pando';
};

// Funci√≥n para verificar si es administrador
const esAdministrador = (email: string): boolean => {
  return email === 'admin@zarparuy.com';
};

// Funci√≥n para verificar permisos de acceso
const tieneAccesoASucursal = (
  email: string, 
  sucursal: string
): boolean => {
  // Admin tiene acceso a todo
  if (esAdministrador(email)) {
    return true;
  }
  
  // Usuario normal solo a su sucursal
  const emailALowerCase = email.toLowerCase();
  const sucursalALowerCase = sucursal.toLowerCase();
  
  return emailALowerCase.startsWith(sucursalALowerCase);
};
```

### Sistema de Login (IMPLEMENTAR EN FUTURO):

```
Usuario se logea ‚Üí Identifica email ‚Üí Verifica si es Admin ‚Üí 
Extrae sucursal o da acceso total ‚Üí Guarda en sesi√≥n ‚Üí 
Filtra datos seg√∫n permisos
```

#### Ejemplo de Flujo NORMAL:
1. Usuario ingresa: `pando@zarparuy.com`
2. Sistema verifica: NO es admin
3. Sistema identifica: Sucursal = "Pando"
4. Sistema carga: `clientes_pando`
5. Usuario SOLO ve clientes de Pando
6. Usuario SOLO ve vendedores de Pando

#### Ejemplo de Flujo ADMINISTRADOR:
1. Usuario ingresa: `admin@zarparuy.com`
2. Sistema verifica: ‚úÖ ES ADMINISTRADOR
3. Sistema da acceso: TODAS las sucursales
4. Sistema carga: TODAS las tablas de clientes
5. Admin ve: Selector de sucursales para filtrar O ver todas juntas
6. Admin ve: TODOS los vendedores de TODAS las sucursales

### ‚ö†Ô∏è IMPORTANTE:
- Cada sucursal es INDEPENDIENTE (excepto para admin)
- NO mezclar datos entre sucursales (excepto admin que puede verlas todas)
- Validar SIEMPRE la sucursal antes de queries
- Proteger rutas por sucursal Y verificar rol
- **SIEMPRE** verificar si el usuario es `admin@zarparuy.com` antes de filtrar
- Si es admin ‚Üí acceso total
- Si NO es admin ‚Üí acceso solo a su sucursal

### üîê L√≥gica de Permisos a Implementar:

```typescript
// En cada endpoint que accede a clientes
const obtenerClientes = async (req, res) => {
  const userEmail = req.user.email; // Del token JWT
  const sucursalSolicitada = req.params.sucursal;
  
  // ‚≠ê Si es admin, permitir acceso a cualquier sucursal
  if (userEmail === 'admin@zarparuy.com') {
    // Admin puede solicitar cualquier sucursal o todas
    if (sucursalSolicitada === 'todas') {
      // Retornar clientes de todas las sucursales
      return await obtenerTodosLosClientes();
    } else {
      // Retornar clientes de la sucursal espec√≠fica
      return await obtenerClientesDeSucursal(sucursalSolicitada);
    }
  }
  
  // üîπ Usuario normal: solo su sucursal
  const sucursalDelUsuario = extraerSucursalDelEmail(userEmail);
  
  // Validar que solo acceda a su sucursal
  if (sucursalSolicitada !== sucursalDelUsuario) {
    return res.status(403).json({ 
      error: 'No tienes permiso para acceder a esta sucursal' 
    });
  }
  
  return await obtenerClientesDeSucursal(sucursalDelUsuario);
};
```

---

## üóÑÔ∏è REGLA #6: OPTIMIZACI√ìN DE BASE DE DATOS

### Filosof√≠a: MENOS es M√ÅS

#### Antes de Crear una Tabla Nueva:
1. ¬øPuedo agregar columnas a una tabla existente? ‚Üí **PREFIERE ESTO**
2. ¬øEs necesario por performance? ‚Üí Considera crear tabla
3. ¬øEs necesario por seguridad? ‚Üí Considera crear tabla
4. ¬øEs necesario por escalabilidad? ‚Üí Considera crear tabla

#### Principios de Dise√±o:

**‚úÖ BUENAS PR√ÅCTICAS:**
- Reutilizar tablas existentes agregando columnas
- Normalizar datos (evitar redundancia)
- Usar √≠ndices en columnas frecuentemente consultadas
- Usar foreign keys para relaciones
- Nombres descriptivos en espa√±ol o ingl√©s consistente

**‚ùå MALAS PR√ÅCTICAS:**
- Crear tabla para cada cosa peque√±a
- Duplicar informaci√≥n
- Tablas con 2-3 columnas cuando pueden estar en otra
- Nombres confusos o inconsistentes

#### Consultar ANTES de:
- Crear nueva tabla
- Modificar estructura existente
- Eliminar columnas con datos

#### Ejemplo de Pensamiento:

```
Usuario pide: "Quiero guardar el color favorito del cliente"

‚ùå MAL: Crear tabla "colores_favoritos"
‚úÖ BIEN: Agregar columna "color_favorito" a tabla de clientes

Usuario pide: "Quiero historial de compras del cliente"

‚ùå MAL: Agregar 100 columnas "compra_1", "compra_2"... 
‚úÖ BIEN: Crear tabla "compras" relacionada con "clientes"
```

---

## üìö REGLA #7: EXPLICAR TODO (ENSE√ëAR)

### Template de Explicaci√≥n:

```markdown
## üîß Lo que hice:
[Descripci√≥n breve en espa√±ol simple]

## ü§î ¬øPor qu√©?
[Raz√≥n t√©cnica explicada de forma simple]

## üìñ ¬øC√≥mo funciona?
[Analog√≠a del mundo real + explicaci√≥n t√©cnica]

## üí° Conceptos que aprendiste:
- Concepto 1: explicaci√≥n
- Concepto 2: explicaci√≥n

## üöÄ Beneficios:
- Beneficio 1
- Beneficio 2

## ‚ö†Ô∏è Cuidados:
[Si hay algo que tener en cuenta]
```

### Ejemplo Real:

```markdown
## üîß Lo que hice:
Agregu√© un useEffect que carga los clientes autom√°ticamente

## ü§î ¬øPor qu√©?
Porque cada vez que cambias de sucursal, necesitas ver los 
clientes diferentes. Sin esto, tendr√≠as que refrescar la p√°gina.

## üìñ ¬øC√≥mo funciona?
Imagina que tienes un sensor de movimiento en tu casa. Cuando 
detecta que entraste, autom√°ticamente enciende las luces. 
useEffect es como ese sensor: detecta cuando cambi√≥ la sucursal 
y autom√°ticamente carga los clientes nuevos.

## üí° Conceptos que aprendiste:
- useEffect: Hook que ejecuta c√≥digo cuando algo cambia
- Dependencies: Lista de cosas que "vigilamos"
- Side Effects: Acciones que afectan fuera del componente

## üöÄ Beneficios:
- Actualizaci√≥n autom√°tica
- Mejor experiencia de usuario
- C√≥digo m√°s limpio y organizado
```

---

## üêõ REGLA #8: CERO BUGS, CERO PROBLEMAS

### Filosof√≠a: "M√°s vale prevenir que lamentar"

#### Antes de Cada Cambio:

**Checklist OBLIGATORIO:**
```
[ ] Le√≠ el c√≥digo existente
[ ] Entend√≠ c√≥mo funciona actualmente
[ ] Identifiqu√© qu√© archivos se afectar√°n
[ ] Verifiqu√© que no hay dependencias ocultas
[ ] Planifiqu√© el cambio sin romper nada
[ ] Tengo un plan B si algo falla
```

#### Despu√©s de Cada Cambio:

**Checklist OBLIGATORIO:**
```
[ ] El c√≥digo compila sin errores
[ ] No hay linter errors
[ ] Prob√© la funcionalidad manualmente (si es posible)
[ ] No romp√≠ ninguna funcionalidad existente
[ ] Agregu√© comentarios explicativos
[ ] Actualic√© tipos de TypeScript si es necesario
```

#### Si Encuentras un Bug:

1. **NO LO IGNORES** - Nunca dejes un bug sin resolver
2. **ANALIZA LA CAUSA RA√çZ** - No solo los s√≠ntomas
3. **PROP√ìN SOLUCI√ìN** - Explica qu√© har√°s
4. **IMPLEMENTA CON CUIDADO** - Sin crear nuevos bugs
5. **VERIFICA TODO** - Asegura que se solucion√≥

#### Prevenci√≥n de Bugs:

**‚úÖ HACER:**
- Validar TODOS los inputs
- Manejar TODOS los casos de error
- Usar try-catch en operaciones async
- Agregar tipos de TypeScript
- Comentar c√≥digo complejo
- Probar casos extremos

**‚ùå NO HACER:**
- Asumir que los datos son correctos
- Ignorar warnings
- Dejar console.log en producci√≥n (algunos s√≠)
- Hacer cambios "r√°pidos" sin pensar
- Copiar c√≥digo sin entender

---

## üé® REGLA #9: INTERFAZ PROFESIONAL Y RESPONSIVE

### Principios de Dise√±o:

#### 1. Responsive 100%
```typescript
// SIEMPRE usar breakpoints de Ant Design
<Row gutter={[16, 16]}>
  <Col xs={24} sm={12} md={8} lg={6} xl={4}>
    {/* Contenido */}
  </Col>
</Row>

// xs: m√≥viles (< 576px) - Full width
// sm: tablets peque√±as (‚â• 576px)
// md: tablets (‚â• 768px)
// lg: desktop (‚â• 992px)
// xl: pantallas grandes (‚â• 1200px)
```

#### 2. Iconos Elegantes (Ant Design Icons)
```typescript
import {
  DashboardOutlined,    // Para dashboard
  UserOutlined,         // Para usuarios
  ShoppingOutlined,     // Para ventas
  DatabaseOutlined,     // Para BD
  // etc... SIEMPRE usar iconos sem√°nticos
} from '@ant-design/icons';
```

#### 3. Animaciones Suaves
```typescript
// En CSS/Inline styles
transition: 'all 0.3s ease'

// Para hover effects
style={{
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  transform: hover ? 'translateY(-4px)' : 'translateY(0)',
  boxShadow: hover ? '0 12px 24px rgba(0,0,0,0.15)' : '0 2px 8px rgba(0,0,0,0.1)'
}}
```

#### 4. Efectos Hover Profesionales
```css
.card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

.button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}
```

#### 5. Paleta de Colores Consistente
```typescript
const COLORS = {
  primary: '#3b82f6',      // Azul principal
  success: '#10b981',      // Verde √©xito
  warning: '#f59e0b',      // Amarillo advertencia
  danger: '#ef4444',       // Rojo peligro
  info: '#8b5cf6',         // Morado info
  gray: {
    50: '#f9fafb',
    100: '#f3f4f6',
    // ... etc
  }
};
```

#### 6. Loading States Elegantes
```typescript
// SIEMPRE mostrar feedback visual
<Button loading={isLoading} icon={<SaveOutlined />}>
  Guardar
</Button>

<Spin spinning={loading} tip="Cargando datos...">
  {contenido}
</Spin>
```

#### 7. Mensajes y Feedback
```typescript
// Usar el sistema de mensajes de Ant Design
message.success('‚úÖ Operaci√≥n exitosa');
message.error('‚ùå Error al procesar');
message.warning('‚ö†Ô∏è Revisa los datos');
message.info('‚ÑπÔ∏è Informaci√≥n importante');
```

### Componentes que SIEMPRE Deben Ser Responsive:

- ‚úÖ Tablas (scroll horizontal en m√≥vil)
- ‚úÖ Formularios (columna √∫nica en m√≥vil)
- ‚úÖ Cards (grid adaptativo)
- ‚úÖ Modales (full screen en m√≥vil)
- ‚úÖ Sidebars (colapsable en m√≥vil)
- ‚úÖ Estad√≠sticas (stack vertical en m√≥vil)

### ‚ö†Ô∏è IMPORTANTE: Selectores (Dropdowns)

**‚ùå NUNCA usar Ant Design Select:**
```typescript
// ‚ùå MAL - NO usar Ant Design Select
import { Select } from 'antd';
<Select options={...} />
```

**‚úÖ SIEMPRE usar react-select:**
```typescript
// ‚úÖ BIEN - Usar react-select con estilos personalizados
import ReactSelect, { StylesConfig } from 'react-select';

const customSelectStyles: StylesConfig = {
  control: (provided, state) => ({
    ...provided,
    minHeight: '38px',
    borderColor: state.isFocused ? '#1890ff' : '#d9d9d9',
    boxShadow: state.isFocused ? '0 0 0 2px rgba(24, 144, 255, 0.2)' : 'none',
    '&:hover': {
      borderColor: '#1890ff'
    },
    cursor: 'pointer',
    borderRadius: '6px'
  }),
  option: (provided, state) => ({
    ...provided,
    backgroundColor: state.isSelected ? '#1890ff' : state.isFocused ? '#e6f7ff' : 'white',
    color: state.isSelected ? 'white' : '#262626',
    cursor: 'pointer',
    padding: '8px 12px',
    '&:active': {
      backgroundColor: '#1890ff'
    }
  }),
  singleValue: (provided) => ({
    ...provided,
    color: '#262626'
  }),
  menu: (provided) => ({
    ...provided,
    borderRadius: '6px',
    boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
    zIndex: 9999
  }),
  menuPortal: (provided) => ({
    ...provided,
    zIndex: 9999
  })
};

<ReactSelect
  value={{ value: 'option1', label: 'Opci√≥n 1' }}
  onChange={(option) => handleChange(option?.value)}
  options={[
    { value: 'option1', label: 'Opci√≥n 1' },
    { value: 'option2', label: 'Opci√≥n 2' }
  ]}
  styles={customSelectStyles}
  isClearable={false}
  isSearchable={true}
  placeholder="Seleccionar..."
  noOptionsMessage={() => 'No hay opciones'}
  menuPortalTarget={document.body}
  menuPosition="fixed"
/>
```

**Razones:**
- ‚úÖ Mejor UX y experiencia visual
- ‚úÖ M√°s personalizable
- ‚úÖ Funciona mejor con datos din√°micos
- ‚úÖ Searchable por defecto
- ‚úÖ Mejor integraci√≥n con React

### üö® PROTOCOLO OBLIGATORIO AL REEMPLAZAR SELECT

**ANTES de hacer commit, SIEMPRE:**

1. **Buscar TODOS los usos:**
```bash
# Buscar en el archivo que est√°s editando
grep -n "<Select\|Select\s\|<Option\|Select\." archivo.tsx
```

2. **Verificar imports:**
```typescript
// ‚ùå Si ves esto, hay un problema:
import { Select } from 'antd';
const { Option } = Select;

// ‚úÖ Debe quedar as√≠:
import ReactSelect, { StylesConfig } from 'react-select';
// (sin Select ni Option)
```

3. **Reemplazar TODOS los usos:**
- ‚ùå NO eliminar `Select` del import si a√∫n se usa en el archivo
- ‚úÖ Buscar TODOS los `<Select` en el archivo
- ‚úÖ Buscar TODOS los `<Option` en el archivo
- ‚úÖ Buscar TODOS los `Select.Option` en el archivo
- ‚úÖ Reemplazar CADA UNO por ReactSelect

4. **Verificar sin errores:**
```bash
# Ejecutar linter
npm run lint archivo.tsx

# Verificar en navegador
# Refrescar p√°gina (CTRL + SHIFT + R)
```

**‚ùå ERROR COM√öN:**
```typescript
// Eliminaste Select del import pero hay un Select en l√≠nea 1050
import { Card, Button } from 'antd'; // ‚ùå Sin Select
// ...
<Select value={x} /> // ‚ùå Esto causar√° error
```

**‚úÖ CORRECTO:**
```typescript
// Opci√≥n 1: Dejar Select si se usa
import { Card, Button, Select } from 'antd';
<Select value={x} />

// Opci√≥n 2: Reemplazar TODO y eliminar Select
import { Card, Button } from 'antd';
import ReactSelect from 'react-select';
<ReactSelect value={{...}} />
```

**‚ö†Ô∏è CHECKLIST OBLIGATORIO:**
```
[ ] Busqu√© TODOS los <Select en el archivo
[ ] Busqu√© TODOS los <Option en el archivo  
[ ] Busqu√© TODOS los Select. en el archivo
[ ] Reemplac√© CADA UNO por ReactSelect
[ ] Elimin√© Select del import de antd
[ ] Elimin√© const { Option } = Select
[ ] Verifiqu√© sin errores de linter
[ ] Prob√© en el navegador
```

---

## üîí REGLA #10: SEGURIDAD M√ÅXIMA

### Protecci√≥n Contra SQL Injection:

#### ‚úÖ SIEMPRE Usar Prepared Statements:
```typescript
// ‚úÖ CORRECTO - Par√°metros seguros
const query = 'SELECT * FROM `users` WHERE id = ?';
await pool.execute(query, [userId]);

// ‚úÖ CORRECTO - M√∫ltiples par√°metros
const query = 'INSERT INTO `clientes` (nombre, email) VALUES (?, ?)';
await pool.execute(query, [nombre, email]);

// ‚ùå NUNCA HACER ESTO - Vulnerable a SQL Injection
const query = `SELECT * FROM users WHERE id = ${userId}`;
await pool.execute(query);

// ‚ùå NUNCA HACER ESTO - Concatenaci√≥n directa
const query = `SELECT * FROM users WHERE name = '${userName}'`;
```

#### ‚úÖ SIEMPRE Escapar Nombres de Tabla/Columna:
```typescript
// ‚úÖ CORRECTO - Backticks protegen
const query = `SELECT * FROM \`${tableName}\` WHERE \`${columnName}\` = ?`;

// ‚ùå INCORRECTO - Sin protecci√≥n
const query = `SELECT * FROM ${tableName} WHERE ${columnName} = ?`;
```

### Validaci√≥n de Inputs:

```typescript
// SIEMPRE validar en Backend
const validarCliente = (data: any) => {
  // Validar campos requeridos
  if (!data.nombre || !data.email) {
    throw new Error('Campos requeridos faltantes');
  }
  
  // Validar formato de email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(data.email)) {
    throw new Error('Email inv√°lido');
  }
  
  // Validar longitud
  if (data.nombre.length > 100) {
    throw new Error('Nombre muy largo');
  }
  
  // Sanitizar (limpiar caracteres peligrosos)
  data.nombre = data.nombre.trim();
  
  return data;
};
```

### Protecci√≥n de Rutas:

```typescript
// Middleware de autenticaci√≥n
const verificarAutenticacion = (req, res, next) => {
  const token = req.headers.authorization;
  
  if (!token) {
    return res.status(401).json({ 
      error: 'No autorizado' 
    });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(403).json({ 
      error: 'Token inv√°lido' 
    });
  }
};

// Aplicar a rutas protegidas
router.get('/clientes', verificarAutenticacion, obtenerClientes);
```

### Variables de Entorno Seguras:

```typescript
// ‚ùå NUNCA hardcodear secretos
const secret = 'mi-password-123';

// ‚úÖ SIEMPRE usar variables de entorno
const secret = process.env.JWT_SECRET;

// ‚úÖ SIEMPRE validar que existan
if (!process.env.JWT_SECRET) {
  throw new Error('JWT_SECRET no est√° configurado');
}
```

### Rate Limiting:

```typescript
// Proteger contra ataques de fuerza bruta
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // m√°ximo 100 requests
  message: 'Demasiadas solicitudes, intenta m√°s tarde'
});

app.use('/api/', limiter);
```

### Sanitizaci√≥n de Datos:

```typescript
// Limpiar datos antes de guardar
const sanitizarInput = (input: string): string => {
  return input
    .trim()                    // Quitar espacios
    .replace(/[<>]/g, '')      // Quitar < >
    .slice(0, 500);            // Limitar longitud
};
```

### Headers de Seguridad:

```typescript
import helmet from 'helmet';

// Agregar headers de seguridad
app.use(helmet());

// Prevenir clickjacking
app.use(helmet.frameguard({ action: 'deny' }));

// Forzar HTTPS
app.use(helmet.hsts({
  maxAge: 31536000,
  includeSubDomains: true
}));
```

---

## üìã CHECKLIST PRE-RESPUESTA

Antes de enviar CUALQUIER respuesta al usuario:

```
[ ] Le√≠ CONTEXTO_AGENTE.md
[ ] Entend√≠ el request del usuario
[ ] Revis√© el c√≥digo existente
[ ] Planifiqu√© sin romper nada
[ ] Consider√© todas las reglas (1-10)
[ ] Prepar√© una explicaci√≥n educativa
[ ] Verifiqu√© seguridad
[ ] Consider√© el rol de admin@zarparuy.com
[ ] Valid√© permisos por sucursal
[ ] NUNCA trato "Administrador" como sucursal
[ ] Filtr√© "Administrador" de listas de sucursales
[ ] Pens√© en responsive
[ ] Todo est√° en espa√±ol
[ ] Tengo una soluci√≥n completa
```

---

## üéØ RESUMEN DE REGLAS

1. ‚úÖ **Base de Datos**: localhost:3307, zarparDataBase, NUNCA cambiar
2. ‚úÖ **Revisar C√≥digo**: SIEMPRE antes de cambiar, NO romper nada
3. ‚úÖ **Espa√±ol**: Todo en espa√±ol, comentarios, mensajes, UI
4. ‚úÖ **Ense√±ar**: Usuario principiante, explicar TODO con ejemplos
5. ‚úÖ **Sucursales**: 7 sucursales f√≠sicas, "Administrador" NO es sucursal
   - üö® **CR√çTICO**: "Administrador" es un ROL, no una sucursal
   - ‚ùå NUNCA incluir "Administrador" en selectores de sucursales
   - ‚úÖ Admin (admin@zarparuy.com) puede ver TODAS las sucursales
6. ‚úÖ **Optimizar BD**: Evitar tablas innecesarias, agregar columnas primero
7. ‚úÖ **Explicar**: Ense√±ar el "por qu√©" y "c√≥mo" con analog√≠as
8. ‚úÖ **Sin Bugs**: Revisar TODO, prevenir problemas, solucionar BIEN
9. ‚úÖ **UI Profesional**: 100% responsive, iconos, animaciones, hover
10. ‚úÖ **Seguridad**: Prepared statements, validaci√≥n, sanitizaci√≥n

---

## üöÄ TECNOLOG√çAS DEL PROYECTO

- **Frontend**: React 18 + TypeScript + Vite + Ant Design 5
- **Backend**: Node.js + Express + TypeScript
- **Base de Datos**: MySQL 8.0
- **Puertos**: Frontend:5678, Backend:3456, MySQL:3307

---

---

## üÜï REGLA #11: GESTI√ìN DE VENDEDORES - ELIMINACI√ìN INTELIGENTE

### üîÑ Sistema Implementado: Hard Delete + Soft Delete Fallback

**IMPORTANTE**: El sistema de eliminaci√≥n de vendedores usa una l√≥gica inteligente que balancea la solicitud del usuario con la integridad de datos.

#### Flujo de Eliminaci√≥n:

```typescript
// 1. Usuario hace clic en "Eliminar" en StaffSellers.tsx
// 2. Frontend muestra advertencia FUERTE de eliminaci√≥n permanente
// 3. Backend intenta HARD DELETE primero
// 4. Si falla por Foreign Key ‚Üí SOFT DELETE autom√°tico
```

#### C√≥digo de Referencia (Backend):

**Archivo**: `api/controllers/vendedoresController.ts`

```typescript
export const eliminarVendedor = async (req, res) => {
  try {
    // Verificar que existe
    const vendedor = await buscarVendedor(id);
    
    // Intentar HARD DELETE primero
    try {
      await executeQuery('DELETE FROM vendedores WHERE id = ?', [id]);
      
      return res.json({
        success: true,
        message: 'Vendedor eliminado permanentemente',
        data: { eliminado_permanentemente: true }
      });
      
    } catch (deleteError) {
      // Si falla por Foreign Key Constraint
      if (deleteError.code === 'ER_ROW_IS_REFERENCED_2' || deleteError.errno === 1451) {
        
        // Fallback a SOFT DELETE
        await executeQuery(
          'UPDATE vendedores SET activo = 0 WHERE id = ?',
          [id]
        );
        
        return res.json({
          success: true,
          message: 'Vendedor desactivado (tiene datos relacionados)',
          data: { 
            eliminado_permanentemente: false,
            desactivado: true 
          }
        });
      }
      throw deleteError;
    }
  } catch (error) {
    // Error general
  }
};
```

#### Frontend - Advertencia Visual:

**Archivo**: `src/pages/staff/StaffSellers.tsx`

```typescript
<Popconfirm
  title="‚ö†Ô∏è ¬°ELIMINAR PERMANENTEMENTE!"
  description={
    <div>
      <p>¬øEst√°s seguro de eliminar a <strong>"{vendedor.nombre}"</strong>?</p>
      <Alert
        message="ADVERTENCIA: Esta acci√≥n es IRREVERSIBLE"
        description="El vendedor ser√° BORRADO PERMANENTEMENTE..."
        type="error"
        showIcon
      />
    </div>
  }
  onConfirm={() => handleEliminarVendedor(id)}
  okText="üóëÔ∏è S√ç, ELIMINAR PERMANENTEMENTE"
  cancelText="‚ùå Cancelar"
/>
```

#### Mensajes de Feedback:

```typescript
// En handleEliminarVendedor (frontend)
if (response.data.data?.eliminado_permanentemente) {
  // ‚úÖ Hard delete exitoso
  messageApi.success('üóëÔ∏è Vendedor eliminado permanentemente');
  
} else if (response.data.data?.desactivado) {
  // ‚ö†Ô∏è Soft delete por Foreign Keys
  messageApi.warning(
    '‚ö†Ô∏è El vendedor tiene datos relacionados y fue desactivado'
  );
}
```

### üîó Foreign Key Constraints Detectadas:

Las siguientes tablas tienen relaciones con `vendedores`:

```sql
clientes_pando         ‚Üí vendedor_id (FK)
clientes_maldonado     ‚Üí vendedor_id (FK)
clientes_rivera        ‚Üí vendedor_id (FK)
clientes_melo          ‚Üí vendedor_id (FK)
clientes_paysandu      ‚Üí vendedor_id (FK)
clientes_salto         ‚Üí vendedor_id (FK)
clientes_tacuarembo    ‚Üí vendedor_id (FK)
```

**TOTAL**: 7 Foreign Keys

### ‚ö†Ô∏è REGLAS PARA FUTUROS CAMBIOS:

1. **NUNCA** forzar eliminaci√≥n con `ON DELETE CASCADE` sin consultar
2. **SIEMPRE** intentar hard delete primero
3. **SIEMPRE** hacer fallback a soft delete si hay relaciones
4. **SIEMPRE** informar al usuario qu√© tipo de eliminaci√≥n ocurri√≥
5. **CONSIDERAR** crear una "papelera de reciclaje" para reactivar vendedores

### üéØ Casos de Uso:

#### Caso 1: Vendedor SIN clientes ni ventas
```
Usuario elimina ‚Üí Backend intenta DELETE ‚Üí ‚úÖ √âxito
Resultado: Vendedor ELIMINADO PERMANENTEMENTE
Mensaje: "üóëÔ∏è Vendedor eliminado permanentemente de la base de datos"
```

#### Caso 2: Vendedor CON clientes o ventas
```
Usuario elimina ‚Üí Backend intenta DELETE ‚Üí ‚ùå Error FK Constraint
‚Üí Backend hace UPDATE activo = 0 ‚Üí ‚úÖ √âxito
Resultado: Vendedor DESACTIVADO (soft delete)
Mensaje: "‚ö†Ô∏è El vendedor tiene clientes o ventas asociadas. 
Se ha DESACTIVADO para preservar el historial."
```

### üîê Seguridad y Permisos:

**Endpoints de Vendedores** (`api/routes/vendedores.ts`):

```typescript
// Todas las operaciones requieren autenticaci√≥n
router.use(verificarAutenticacion);

// Solo admin puede crear/editar/eliminar
router.post('/', verificarAdmin, crearVendedor);
router.put('/:id', verificarAdmin, actualizarVendedor);
router.delete('/:id', verificarAdmin, eliminarVendedor);

// Todos pueden ver (filtrado por sucursal)
router.get('/', obtenerVendedores);
```

### üìä Campos de la Tabla `vendedores`:

```sql
CREATE TABLE vendedores (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  apellido VARCHAR(100) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  telefono VARCHAR(20),
  cargo VARCHAR(50),
  sucursal VARCHAR(50) NOT NULL,
  activo TINYINT(1) DEFAULT 1,  -- ‚ö†Ô∏è Campo para soft delete
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### üí° Mejoras Futuras Sugeridas:

1. **Papelera de Reciclaje**:
   - Vista de vendedores desactivados (activo = 0)
   - Bot√≥n "Reactivar" para restaurar vendedores
   - Bot√≥n "Eliminar permanentemente" desde papelera
   
2. **Historial de Auditor√≠a**:
   - Tabla `vendedores_log` con:
     - Qui√©n elimin√≥/desactiv√≥
     - Cu√°ndo
     - Raz√≥n
   
3. **Verificaci√≥n Preventiva**:
   - Antes de mostrar el modal de eliminaci√≥n
   - Consultar si tiene relaciones
   - Mostrar mensaje diferente seg√∫n el caso

---

## üÜï REGLA #12: SISTEMA DIN√ÅMICO DE SUCURSALES - ESCALABLE Y ROBUSTO

### üéØ FILOSOF√çA: "Crea Una Vez, Funciona Siempre"

**IMPORTANTE**: El sistema est√° dise√±ado para que **CUALQUIER NUEVA SUCURSAL** creada tenga **TODAS** las funcionalidades autom√°ticamente, sin necesidad de modificar c√≥digo.

---

### ‚úÖ CARACTER√çSTICAS DIN√ÅMICAS IMPLEMENTADAS

#### 1. **Carga Din√°mica de Sucursales desde Base de Datos**

Todas las partes del sistema que necesitan listar sucursales **CARGAN DIN√ÅMICAMENTE** desde la base de datos:

```typescript
// ‚ùå ANTES (Hardcodeado)
const SUCURSALES = ['pando', 'maldonado', 'rivera', ...];

// ‚úÖ AHORA (Din√°mico)
const sucursales = await obtenerTodasLasSucursales(); // Desde BD
```

**Archivos Actualizados**:
- ‚úÖ `src/pages/products/Products.tsx` - Carga sucursales din√°micamente
- ‚úÖ `src/pages/pos/POS.tsx` - Carga sucursales din√°micamente
- ‚úÖ `api/controllers/authController.ts` - Tablas de clientes din√°micas
- ‚úÖ `api/middleware/auth.ts` - Permisos din√°micos por sucursal

---

### üì¶ M√ìDULO DE UTILIDADES: `api/utils/database.ts`

**Archivo Central**: `api/utils/database.ts`

Este m√≥dulo contiene funciones helper reutilizables para operaciones din√°micas con la base de datos:

```typescript
/**
 * Obtener TODAS las tablas de clientes din√°micamente
 * Busca en information_schema todas las tablas que empiecen con "clientes_"
 */
export const obtenerTodasLasTablas = async (): Promise<string[]> => {
  // Consulta TODAS las tablas clientes_* desde la BD
  // Retorna: ['clientes_pando', 'clientes_maldonado', 'clientes_soriano', ...]
}

/**
 * Obtener informaci√≥n completa de sucursales
 */
export const obtenerTodasLasSucursales = async (): Promise<SucursalInfo[]> => {
  // Retorna: [
  //   { sucursal: 'pando', tabla_clientes: 'clientes_pando' },
  //   { sucursal: 'soriano', tabla_clientes: 'clientes_soriano' },
  //   ...
  // ]
}

/**
 * Verificar si una tabla de clientes existe
 */
export const tablaClientesExiste = async (nombreSucursal: string): Promise<boolean> => {
  // Verifica din√°micamente si existe clientes_[nombreSucursal]
}

/**
 * Obtener nombres de sucursales (sin prefijo)
 */
export const obtenerNombresSucursales = async (): Promise<string[]> => {
  // Retorna: ['pando', 'maldonado', 'soriano', ...]
}
```

**Ubicaci√≥n**: `api/utils/database.ts`

---

### üîê AUTENTICACI√ìN DIN√ÅMICA

#### Admin - Acceso a TODAS las Sucursales

**Antes** (Hardcodeado):
```typescript
if (esAdmin) {
  tablasClientes = [
    'clientes_pando',
    'clientes_maldonado',
    'clientes_rivera',
    // ... hardcodeado
  ];
}
```

**Ahora** (Din√°mico):
```typescript
if (esAdmin) {
  // Carga TODAS las tablas de clientes desde la BD
  tablasClientes = await obtenerTodasLasTablas();
  // Incluye autom√°ticamente CUALQUIER nueva sucursal creada
}
```

**Beneficio**: Cuando creas "Soriano", el admin AUTOM√ÅTICAMENTE tiene acceso a `clientes_soriano` sin modificar c√≥digo.

---

### üõí PUNTO DE VENTA (POS) - DIN√ÅMICO

**Archivo**: `src/pages/pos/POS.tsx`

```typescript
// Carga sucursales al iniciar
const cargarSucursalesIniciales = async () => {
  const sucursalesData = await vendedoresService.obtenerSucursales();
  setSucursales(sucursalesData);
};

// Efecto inicial
useEffect(() => {
  cargarSucursalesIniciales();
}, []);
```

**Funcionalidad**:
- ‚úÖ Carga sucursales desde API
- ‚úÖ Carga vendedores por sucursal
- ‚úÖ Carga clientes por sucursal
- ‚úÖ TODO din√°mico, nada hardcodeado

---

### üì¶ PRODUCTOS - DIN√ÅMICO

**Archivo**: `src/pages/products/Products.tsx`

```typescript
// Estado din√°mico de sucursales
const [sucursales, setSucursales] = useState<Sucursal[]>([]);

// Cargar sucursales desde API
const cargarSucursales = async () => {
  const response = await fetch(`${API_URL}/sucursales`);
  const data = await response.json();
  setSucursales(data.data);
};

// Efecto inicial
useEffect(() => {
  cargarSucursales();
  cargarProductos();
}, []);
```

**Funcionalidad**:
- ‚úÖ Selector de sucursales din√°mico
- ‚úÖ Actualizar stock/precio por sucursal
- ‚úÖ Bot√≥n "Actualizar" recarga sucursales
- ‚úÖ Colapso de stock por sucursal din√°mico

---

### üè¢ GESTI√ìN DE SUCURSALES - COMPLETO

**Archivo**: `src/pages/staff/StaffSellers.tsx`

#### Crear Nueva Sucursal:
```typescript
const handleCrearSucursal = async (values: any) => {
  // 1. Crea la sucursal en la BD
  // 2. Crea tabla `clientes_[nombre]` autom√°ticamente
  // 3. Crea vendedor inicial para la sucursal
  // 4. LISTO - Ya disponible en TODO el sistema
}
```

**Lo que se crea autom√°ticamente**:
1. ‚úÖ Entrada en sistema de sucursales
2. ‚úÖ Tabla `clientes_[nombre]` con estructura completa
3. ‚úÖ Foreign Keys configuradas correctamente
4. ‚úÖ Vendedor inicial asignado
5. ‚úÖ Disponible en POS, Productos, Auth, etc.

#### Eliminar Sucursal:
```typescript
const handleEliminarSucursal = async (nombre: string) => {
  // 1. Verifica que NO tenga vendedores activos
  // 2. Busca y elimina TODAS las Foreign Keys
  // 3. Elimina tabla de clientes
  // 4. Elimina productos asociados
  // 5. Elimina vendedores inactivos
  // 6. LIMPIEZA COMPLETA - Sin residuos
}
```

**Validaciones**:
- ‚ùå No permite eliminar si tiene vendedores activos
- ‚úÖ Elimina Foreign Keys din√°micamente
- ‚úÖ Limpieza completa de datos relacionados
- ‚úÖ Soluci√≥n robusta, NO temporal

---

### üîÑ FLUJO COMPLETO: CREAR NUEVA SUCURSAL

```
Usuario crea sucursal "Soriano" con vendedor "Sol Pascual"
‚Üì
Backend crea:
  ‚îú‚îÄ Tabla: clientes_soriano (con FK a vendedores)
  ‚îú‚îÄ Vendedor: Sol Pascual (sucursal: soriano)
  ‚îî‚îÄ Entrada en sistema de sucursales
‚Üì
Frontend detecta autom√°ticamente:
  ‚îú‚îÄ POS: "Soriano" aparece en selector
  ‚îú‚îÄ Productos: "Soriano" aparece para asignar stock/precios
  ‚îú‚îÄ Auth: Admin tiene acceso a clientes_soriano
  ‚îî‚îÄ Dashboard: Sucursal visible en estad√≠sticas
‚Üì
‚úÖ LISTO - Funciona como cualquier otra sucursal
NO SE NECESITA MODIFICAR C√ìDIGO
```

---

### üìã CHECKLIST: NUEVA SUCURSAL COMPLETAMENTE FUNCIONAL

Cuando creas una nueva sucursal, autom√°ticamente tiene:

```
‚úÖ Tabla de clientes propia (clientes_[nombre])
‚úÖ Vendedores pueden ser asignados
‚úÖ Aparece en selector de POS
‚úÖ Aparece en selector de Productos
‚úÖ Puede recibir stock y precios de productos
‚úÖ Admin tiene acceso autom√°tico
‚úÖ Vendedores de esa sucursal tienen permisos correctos
‚úÖ Sistema de autenticaci√≥n la reconoce
‚úÖ Puede hacer ventas en POS
‚úÖ Puede gestionar clientes
‚úÖ Visible en estad√≠sticas (cuando se implementen)
```

**TOTAL**: 11/11 funcionalidades ‚úÖ

---

### ‚ö†Ô∏è REGLAS CR√çTICAS PARA MANTENER EL SISTEMA DIN√ÅMICO

#### ‚ùå NUNCA HACER:
1. **NO hardcodear listas de sucursales** en ning√∫n lugar del c√≥digo
2. **NO crear arrays como** `const SUCURSALES = ['pando', 'maldonado', ...]`
3. **NO asumir** que solo existen las 7 sucursales originales
4. **NO usar** bucles con sucursales hardcodeadas

#### ‚úÖ SIEMPRE HACER:
1. **SIEMPRE cargar** sucursales desde la BD usando funciones del m√≥dulo `api/utils/database.ts`
2. **SIEMPRE usar** `obtenerTodasLasTablas()` para obtener tablas de clientes
3. **SIEMPRE verificar** din√°micamente si una tabla existe
4. **SIEMPRE usar** `fetch('/api/sucursales')` en el frontend para listar sucursales
5. **SIEMPRE actualizar** el frontend cuando cambian las sucursales

---

### üîß FUNCIONES A USAR EN CADA CONTEXTO

#### Backend (API):
```typescript
import { 
  obtenerTodasLasTablas,
  obtenerTodasLasSucursales,
  tablaClientesExiste,
  obtenerNombresSucursales
} from '../utils/database.js';

// Para autenticaci√≥n
const tablasClientes = await obtenerTodasLasTablas();

// Para verificar existencia
const existe = await tablaClientesExiste('soriano');

// Para listar sucursales
const sucursales = await obtenerNombresSucursales();
```

#### Frontend (React):
```typescript
// En cualquier componente
const [sucursales, setSucursales] = useState<Sucursal[]>([]);

const cargarSucursales = async () => {
  const response = await fetch(`${API_URL}/sucursales`);
  const data = await response.json();
  setSucursales(data.data);
};

useEffect(() => {
  cargarSucursales();
}, []);

// Usar sucursales en JSX
{sucursales.map(sucursal => (
  <Option key={sucursal.sucursal} value={sucursal.sucursal}>
    {sucursal.sucursal.toUpperCase()}
  </Option>
))}
```

---

### üéØ PRUEBA DE ROBUSTEZ

Para verificar que el sistema es verdaderamente din√°mico:

1. **Crear nueva sucursal** (ej: "Soriano") con vendedor
2. **Refrescar p√°ginas**: POS, Productos, Staff
3. **Verificar que "Soriano" aparece** en TODOS los selectores
4. **Iniciar sesi√≥n** con vendedor de "Soriano"
5. **Hacer venta** en POS con "Soriano"
6. **Asignar productos** con stock/precio para "Soriano"
7. **Eliminar sucursal** y verificar limpieza completa

**Si TODOS los pasos funcionan**: ‚úÖ Sistema robusto y escalable

---

### üì¶ ARCHIVOS CLAVE DE LA SOLUCI√ìN DIN√ÅMICA

```
api/utils/database.ts            # ‚≠ê Funciones helper din√°micas (NUEVO)
api/controllers/authController.ts # ‚≠ê Usa obtenerTodasLasTablas() (ACTUALIZADO)
api/middleware/auth.ts           # ‚≠ê Usa obtenerTodasLasTablas() (ACTUALIZADO)
src/pages/products/Products.tsx  # ‚≠ê Carga sucursales din√°micamente (ACTUALIZADO)
src/pages/pos/POS.tsx           # ‚≠ê Carga sucursales din√°micamente (YA ERA DIN√ÅMICO)
src/pages/staff/StaffSellers.tsx # ‚≠ê Crear/Eliminar sucursales (YA IMPLEMENTADO)
```

---

### üí° BENEFICIOS DE LA SOLUCI√ìN DIN√ÅMICA

1. **Escalabilidad**: Agregar 10, 20, 50 sucursales sin tocar c√≥digo
2. **Mantenibilidad**: Sin listas hardcodeadas que actualizar
3. **Consistencia**: Una sola fuente de verdad (la base de datos)
4. **Flexibilidad**: Sistema se adapta autom√°ticamente a cambios
5. **Productividad**: Crear sucursales en segundos, no horas
6. **Confiabilidad**: Menos puntos de fallo por c√≥digo hardcodeado
7. **Profesionalismo**: Sistema enterprise-grade escalable

---

### üöÄ PR√ìXIMOS PASOS SUGERIDOS

1. **Cache de Sucursales**: Implementar cache en memoria para reducir queries
2. **WebSocket**: Notificar en tiempo real cuando se crea/elimina sucursal
3. **Migraciones**: Sistema de migraciones para cambios en esquema
4. **Auditor√≠a**: Log de creaci√≥n/eliminaci√≥n de sucursales
5. **Backup Autom√°tico**: Antes de eliminar sucursal, backup autom√°tico

---

## üìö ARCHIVOS CR√çTICOS DEL PROYECTO

### Backend (API):
```
api/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.ts          # Conexi√≥n MySQL con pool
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ vendedoresController.ts   # ‚≠ê CRUD de vendedores (eliminaci√≥n inteligente)
‚îÇ   ‚îú‚îÄ‚îÄ clientesController.ts     # Gesti√≥n de clientes
‚îÇ   ‚îî‚îÄ‚îÄ productosController.ts    # Gesti√≥n de productos
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ vendedores.ts        # ‚≠ê Rutas de vendedores (protegidas)
‚îÇ   ‚îú‚îÄ‚îÄ clientes.ts          # Rutas de clientes
‚îÇ   ‚îî‚îÄ‚îÄ productos.ts         # Rutas de productos
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts              # verificarAutenticacion, verificarAdmin
‚îî‚îÄ‚îÄ index.ts                 # Servidor Express
```

### Frontend (React):
```
src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ staff/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StaffSellers.tsx      # ‚≠ê Gesti√≥n de vendedores (con eliminaci√≥n)
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DatabaseManager.tsx   # Administrador de BD
‚îÇ   ‚îî‚îÄ‚îÄ pos/
‚îÇ       ‚îî‚îÄ‚îÄ POS.tsx              # Punto de venta
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts               # ‚≠ê Servicios API (vendedoresService)
‚îî‚îÄ‚îÄ App.tsx                  # Router principal
```

### Base de Datos:
```
database/
‚îú‚îÄ‚îÄ backup_completo.sql              # ‚≠ê Backup principal (USAR ESTE)
‚îú‚îÄ‚îÄ backup_completo_20251031_*.sql   # Backups con timestamp
‚îî‚îÄ‚îÄ schema.sql                       # Esquema de tablas
```

---

**√öltima actualizaci√≥n**: Octubre 31, 2025  
**Versi√≥n**: 2.0.0  
**Estado**: ACTIVO - LEER SIEMPRE

---

## üÜï REGLA #13: ENCODING UTF-8 - MANEJO CORRECTO (CR√çTICO)

### üéØ FILOSOF√çA: "Un Solo Charset para Gobernarlos a Todos"

**CR√çTICO**: El sistema DEBE manejar caracteres especiales (√°, √©, √≠, √≥, √∫, √±, √ë) correctamente en TODA la cadena: MySQL ‚Üí Node.js ‚Üí React ‚Üí PDF.

---

### ‚úÖ CONFIGURACI√ìN OBLIGATORIA

#### 1. **Backend: Conexi√≥n MySQL** (`api/config/database.ts`)

```typescript
import mysql from 'mysql2/promise';

export const pool = mysql.createPool({
  host: process.env.DB_HOST || 'localhost',
  port: Number(process.env.DB_PORT) || 3307,
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME || 'zarparDataBase',
  
  // ‚úÖ CR√çTICO: Configuraci√≥n UTF-8
  charset: 'utf8mb4',
  connectAttributes: {
    charset: 'utf8mb4'
  }
});

// ‚úÖ CR√çTICO: Configurar UTF-8 en cada conexi√≥n
const testConnection = async () => {
  try {
    const connection = await pool.getConnection();
    
    // ‚úÖ Configurar UTF-8 expl√≠citamente
    await connection.query("SET NAMES 'utf8mb4'");
    await connection.query("SET CHARACTER SET utf8mb4");
    await connection.query("SET character_set_connection=utf8mb4");
    
    connection.release();
    console.log('‚úÖ Conexi√≥n a MySQL exitosa con UTF-8');
  } catch (error) {
    console.error('‚ùå Error de conexi√≥n a MySQL:', error);
  }
};
```

#### 2. **Scripts SQL: SIEMPRE Usar UTF-8**

```bash
# ‚úÖ CORRECTO - Ejecutar SQL con UTF-8
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 --default-character-set=utf8mb4 zarparDataBase < archivo.sql

# ‚ùå INCORRECTO - Sin charset
docker exec -i zarpar-mysql mysql -u root -pzarpar2025 zarparDataBase < archivo.sql
```

#### 3. **Frontend: PDFs con UTF-8** (jsPDF)

```typescript
import jsPDF from 'jspdf';
import 'jspdf-autotable';

const generarPDF = () => {
  const doc = new jsPDF();
  
  // ‚úÖ Los datos ya vienen correctos desde la API con UTF-8
  // No necesitas hacer conversi√≥n
  
  doc.text(`Bater√≠a`, 10, 10);  // ‚úÖ Se renderiza correctamente
  doc.text(`Bot√≥n`, 10, 20);    // ‚úÖ Se renderiza correctamente
};
```

---

### üêõ PROBLEMAS COMUNES Y SOLUCIONES

#### Problema 1: Doble Encoding (Bater√É¬≠a en vez de Bater√≠a)

**Causa**: Datos guardados con charset incorrecto

**Soluci√≥n**:
```sql
-- Ejecutar script de correcci√≥n
USE zarparDataBase;
SET NAMES 'utf8mb4';

-- Corregir datos corruptos
UPDATE productos 
SET tipo = REPLACE(tipo, 'Bater√É¬≠a', 'Bater√≠a') 
WHERE tipo LIKE '%Bater√É¬≠a%';

UPDATE productos 
SET tipo = REPLACE(tipo, 'Bot√É¬≥n', 'Bot√≥n') 
WHERE tipo LIKE '%Bot√É¬≥n%';
```

#### Problema 2: Caracteres Corruptos en Clientes

**Soluci√≥n**:
```sql
-- Corregir acentos comunes en todas las tablas de clientes
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬°', '√°') WHERE nombre LIKE '%√É¬°%';
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬©', '√©') WHERE nombre LIKE '%√É¬©%';
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬≠', '√≠') WHERE nombre LIKE '%√É¬≠%';
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬≥', '√≥') WHERE nombre LIKE '%√É¬≥%';
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬∫', '√∫') WHERE nombre LIKE '%√É¬∫%';
UPDATE clientes_pando SET nombre = REPLACE(nombre, '√É¬±', '√±') WHERE nombre LIKE '%√É¬±%';

-- Repetir para apellido y direccion
-- Repetir para TODAS las tablas de clientes
```

---

### üìã VERIFICACI√ìN DE ENCODING

#### Verificar HEX de un Campo

```sql
-- Verificar encoding correcto
SELECT 
  tipo,
  HEX(tipo) as hex_value,
  CASE
    WHEN HEX(tipo) = '4261746572C3AD61' THEN '‚úÖ UTF-8 Correcto (Bater√≠a)'
    WHEN HEX(tipo) LIKE '%C383C2AD%' THEN '‚ùå Doble Encoding'
    ELSE '‚ö†Ô∏è Revisar'
  END as estado
FROM productos
WHERE tipo LIKE '%Bater%';

-- Resultado esperado:
-- tipo: Bater√≠a
-- hex_value: 4261746572C3AD61
-- estado: ‚úÖ UTF-8 Correcto
```

#### Buscar Datos Corruptos

```sql
-- Buscar caracteres corruptos en cualquier tabla
SELECT * FROM clientes_pando
WHERE nombre LIKE '%√É%' 
   OR apellido LIKE '%√É%' 
   OR direccion LIKE '%√É%';

-- Si retorna registros = HAY CORRUPCI√ìN ‚ùå
-- Si retorna vac√≠o = TODO CORRECTO ‚úÖ
```

---

### üîí GARANT√çAS POST-CONFIGURACI√ìN

Una vez configurado correctamente, el sistema garantiza:

‚úÖ **Charset UTF-8 en toda la cadena**:
```
MySQL (utf8mb4) 
    ‚Üì
Node.js Pool (utf8mb4) 
    ‚Üì
API REST (UTF-8) 
    ‚Üì
React Frontend (UTF-8) 
    ‚Üì
PDF (UTF-8)
```

‚úÖ **Datos almacenados correctamente**
‚úÖ **Datos recuperados correctamente**
‚úÖ **PDFs generados con acentos correctos**
‚úÖ **Futuras inserciones protegidas**

---

### ‚ö†Ô∏è REGLAS CR√çTICAS

#### ‚ùå NUNCA HACER:
1. **NO** modificar el charset del pool sin documentar
2. **NO** ejecutar scripts SQL sin `--default-character-set=utf8mb4`
3. **NO** copiar datos de fuentes externas sin verificar encoding
4. **NO** asumir que los datos ya tienen el encoding correcto

#### ‚úÖ SIEMPRE HACER:
1. **SIEMPRE** usar la configuraci√≥n UTF-8 en el pool
2. **SIEMPRE** ejecutar SQL con charset utf8mb4
3. **SIEMPRE** verificar encoding despu√©s de importar datos
4. **SIEMPRE** probar con caracteres especiales (Jos√© P√©rez, M√≥nica L√≥pez)
5. **SIEMPRE** generar PDFs y verificar acentos

---

### üìö SCRIPTS DE AUDITOR√çA Y CORRECCI√ìN

**Ubicaci√≥n**: `database/` y `scripts/`

```
database/
‚îú‚îÄ‚îÄ fix_all_tipos.sql                  # Correcci√≥n de productos
‚îú‚îÄ‚îÄ FIX_ALL_ENCODING_MAESTRO.sql       # Correcci√≥n de clientes
‚îú‚îÄ‚îÄ verificar_datos_corruptos.sql      # B√∫squeda de problemas
‚îî‚îÄ‚îÄ AUDITORIA_ENCODING_COMPLETA.md     # Reporte completo

scripts/
‚îî‚îÄ‚îÄ audit-encoding-completo.sql        # Auditor√≠a de todas las tablas
```

---

### üéØ CUANDO AGREGAR NUEVOS DATOS

```typescript
// Al insertar clientes, productos, etc.
const insertarCliente = async (data: Cliente) => {
  // ‚úÖ La conexi√≥n ya tiene UTF-8 configurado
  // NO necesitas hacer nada especial
  const query = `
    INSERT INTO clientes_pando 
    (nombre, apellido, direccion) 
    VALUES (?, ?, ?)
  `;
  
  // Los acentos se guardar√°n correctamente autom√°ticamente
  await pool.execute(query, [
    'Jos√© P√©rez',        // ‚úÖ Se guarda correctamente
    'Garc√≠a M√≥nica',     // ‚úÖ Se guarda correctamente
    'Calle N√∫√±ez 123'    // ‚úÖ Se guarda correctamente
  ]);
};
```

---

### üìñ DOCUMENTACI√ìN RELACIONADA

- **`SOLUCION_ENCODING_UTF8.md`** - Soluci√≥n t√©cnica detallada
- **`AUDITORIA_ENCODING_COMPLETA.md`** - Reporte de auditor√≠a completa (32 tablas, 155 campos)

---

## üÜï REGLA #14: GENERACI√ìN DE PDFs PROFESIONALES

### üéØ FILOSOF√çA: "PDFs de Calidad Profesional"

El sistema debe generar PDFs con dise√±o profesional, datos din√°micos y encoding correcto.

---

### ‚úÖ DEPENDENCIAS REQUERIDAS

```bash
npm install jspdf jspdf-autotable
```

**TypeScript Types**:
```bash
npm install --save-dev @types/jspdf
```

---

### üì¶ ESTRUCTURA B√ÅSICA DE UN PDF

```typescript
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

const generarPDF = (datos: any[], sucursal: string) => {
  const doc = new jsPDF();
  
  // ========================================
  // 1. HEADER - Informaci√≥n de la empresa
  // ========================================
  doc.setFontSize(20);
  doc.setFont('helvetica', 'bold');
  doc.text('ZARPAR - REPUESTOS', 105, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.text(`Sucursal: ${sucursal.toUpperCase()}`, 105, 30, { align: 'center' });
  
  // ========================================
  // 2. FECHA Y C√ìDIGO
  // ========================================
  const fecha = new Date().toLocaleDateString('es-UY');
  doc.setFontSize(10);
  doc.text(`Fecha: ${fecha}`, 14, 40);
  doc.text(`C√≥digo: ${generarCodigo()}`, 14, 45);
  
  // ========================================
  // 3. TABLA DE DATOS (autoTable)
  // ========================================
  autoTable(doc, {
    startY: 55,
    head: [['#', 'Producto', 'Marca', 'Tipo', 'Precio']],
    body: datos.map((item, index) => [
      index + 1,
      item.nombre,
      item.marca,
      item.tipo,
      `$${item.precio.toLocaleString('es-UY')}`
    ]),
    
    // ‚úÖ Estilos profesionales
    theme: 'striped',
    headStyles: {
      fillColor: [59, 130, 246],  // Azul
      textColor: 255,
      fontSize: 11,
      fontStyle: 'bold',
      halign: 'center'
    },
    bodyStyles: {
      fontSize: 10,
      cellPadding: 3
    },
    alternateRowStyles: {
      fillColor: [245, 247, 250]
    },
    columnStyles: {
      0: { halign: 'center', cellWidth: 15 },   // #
      4: { halign: 'right', cellWidth: 30 }     // Precio
    },
    
    // ‚úÖ Ajuste autom√°tico de texto
    styles: {
      overflow: 'linebreak',
      cellWidth: 'wrap'
    }
  });
  
  // ========================================
  // 4. FOOTER - Informaci√≥n adicional
  // ========================================
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(128);
    doc.text(
      `P√°gina ${i} de ${pageCount}`,
      105,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }
  
  // ========================================
  // 5. GUARDAR PDF
  // ========================================
  doc.save(`Lista_Precios_${sucursal}_${fecha}.pdf`);
};
```

---

### üé® ORDENAMIENTO DE DATOS EN PDFs

**Caso: Lista de Precios de Productos**

```typescript
// ‚úÖ Ordenar productos por tipo y marca
const ordenarProductosPorTipo = (productos: Producto[]): Producto[] => {
  return productos.sort((a, b) => {
    const tipoA = (a.tipo || '').toLowerCase();
    const tipoB = (b.tipo || '').toLowerCase();
    const marcaA = (a.marca || '').toLowerCase();
    const marcaB = (b.marca || '').toLowerCase();
    
    // Funci√≥n para dar prioridad a tipos espec√≠ficos
    const obtenerPrioridad = (tipo: string): number => {
      if (tipo.includes('display')) return 1;
      if (tipo.includes('bateria') || tipo.includes('bater√≠a')) return 2;
      if (tipo.includes('flex')) return 3;
      return 4; // Resto
    };
    
    const prioridadA = obtenerPrioridad(tipoA);
    const prioridadB = obtenerPrioridad(tipoB);
    
    // 1. Ordenar por prioridad de tipo
    if (prioridadA !== prioridadB) {
      return prioridadA - prioridadB;
    }
    
    // 2. Dentro del mismo tipo, ordenar por marca
    if (marcaA !== marcaB) {
      return marcaA.localeCompare(marcaB, 'es');
    }
    
    // 3. Dentro de la misma marca, ordenar por nombre
    return (a.nombre || '').localeCompare(b.nombre || '', 'es');
  });
};
```

**Resultado esperado**:
```
Display
  - Samsung Galaxy S10 Display
  - Samsung Galaxy S20 Display
  - iPhone 11 Display
  - iPhone 12 Display
  
Bater√≠a
  - Huawei P30 Bater√≠a
  - Samsung Galaxy A50 Bater√≠a
  - iPhone X Bater√≠a
  
Flex
  - Samsung Galaxy Note 10 Flex
  ...
```

---

### üìÑ P√ÅGINA: LISTA DE PRECIOS (`/products/prices`)

**Archivo**: `src/pages/products/ProductPrices.tsx`

#### Funcionalidades:
- ‚úÖ Selector de sucursal
- ‚úÖ Tabla con productos y precios
- ‚úÖ Bot√≥n "Generar PDF"
- ‚úÖ Productos ordenados por tipo y marca
- ‚úÖ Datos 100% din√°micos desde base de datos

#### C√≥digo de Ejemplo:

```typescript
const ProductPrices: React.FC = () => {
  const [sucursal, setSucursal] = useState('pando');
  const [productos, setProductos] = useState<ProductoCompleto[]>([]);
  const [loading, setLoading] = useState(false);
  
  // Cargar productos por sucursal
  const cargarProductos = async () => {
    setLoading(true);
    try {
      const data = await productosService.obtenerPorSucursal(sucursal);
      
      // Filtrar solo productos activos con precio > 0
      const productosConPrecio = data
        .filter(p => p.activo && p.precio > 0)
        .map(p => ({ ...p }));
      
      // ‚úÖ Ordenar antes de mostrar
      setProductos(ordenarProductosPorTipo(productosConPrecio));
    } catch (error) {
      message.error('Error al cargar productos');
    } finally {
      setLoading(false);
    }
  };
  
  // Generar PDF
  const generarPDF = () => {
    const doc = new jsPDF();
    
    // Header
    doc.setFontSize(20);
    doc.text('LISTA DE PRECIOS', 105, 20, { align: 'center' });
    doc.setFontSize(14);
    doc.text(`Sucursal: ${sucursal.toUpperCase()}`, 105, 30, { align: 'center' });
    
    // Tabla con productos ya ordenados
    autoTable(doc, {
      startY: 40,
      head: [['#', 'Producto', 'Marca', 'Tipo', 'Precio']],
      body: productos.map((p, i) => [
        i + 1,
        p.nombre,
        p.marca,
        p.tipo,
        `$${p.precio.toLocaleString('es-UY')}`
      ]),
      // ... estilos ...
    });
    
    doc.save(`Lista_Precios_${sucursal}_${new Date().toLocaleDateString('es-UY')}.pdf`);
  };
  
  return (
    <div>
      <Select value={sucursal} onChange={setSucursal}>
        {sucursales.map(s => (
          <Option key={s} value={s}>{s.toUpperCase()}</Option>
        ))}
      </Select>
      
      <Button onClick={generarPDF} icon={<FilePdfOutlined />}>
        Generar PDF
      </Button>
      
      <Table dataSource={productos} loading={loading} />
    </div>
  );
};
```

---

### ‚ö†Ô∏è REGLAS PARA PDFs

#### ‚ùå NUNCA HACER:
1. **NO** hardcodear datos en PDFs
2. **NO** generar PDFs sin ordenar datos
3. **NO** olvidar verificar encoding (acentos)
4. **NO** usar tablas sin estilos profesionales

#### ‚úÖ SIEMPRE HACER:
1. **SIEMPRE** usar datos din√°micos desde base de datos
2. **SIEMPRE** ordenar datos antes de generar PDF
3. **SIEMPRE** aplicar estilos profesionales (colores, bordes)
4. **SIEMPRE** incluir header y footer
5. **SIEMPRE** verificar acentos (Bater√≠a, Bot√≥n, etc.)

---

## üÜï REGLA #15: SISTEMA DE CAJA - GESTI√ìN DE EFECTIVO

### üéØ FILOSOF√çA: "Control Total del Flujo de Efectivo"

El sistema debe rastrear TODOS los ingresos y egresos de efectivo por sucursal, con historial completo y ajustes manuales solo para administradores.

---

### üìä ESTRUCTURA DE BASE DE DATOS

#### Tabla: `caja`

```sql
CREATE TABLE IF NOT EXISTS caja (
  id INT AUTO_INCREMENT PRIMARY KEY,
  sucursal VARCHAR(50) NOT NULL UNIQUE,
  monto_actual DECIMAL(10, 2) DEFAULT 0.00,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_sucursal (sucursal)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### Tabla: `movimientos_caja`

```sql
CREATE TABLE IF NOT EXISTS movimientos_caja (
  id INT AUTO_INCREMENT PRIMARY KEY,
  sucursal VARCHAR(50) NOT NULL,
  tipo_movimiento ENUM(
    'ingreso_venta',                -- Venta en efectivo desde POS
    'ingreso_cuenta_corriente',     -- Pago de cuenta corriente en efectivo
    'envio',                        -- Env√≠o de dinero
    'ajuste_manual'                 -- Ajuste manual por admin
  ) NOT NULL,
  monto DECIMAL(10, 2) NOT NULL,
  monto_anterior DECIMAL(10, 2) NOT NULL,
  monto_nuevo DECIMAL(10, 2) NOT NULL,
  concepto TEXT,
  venta_id INT NULL,
  pago_cuenta_corriente_id INT NULL,
  usuario_id INT NULL,
  usuario_email VARCHAR(255) NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_sucursal (sucursal),
  INDEX idx_tipo_movimiento (tipo_movimiento),
  INDEX idx_created_at (created_at),
  INDEX idx_venta_id (venta_id),
  INDEX idx_pago_cc_id (pago_cuenta_corriente_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### üîÑ INTEGRACI√ìN AUTOM√ÅTICA CON VENTAS

**Archivo**: `api/controllers/ventasController.ts`

```typescript
export const crearVenta = async (req, res) => {
  const connection = await pool.getConnection();
  
  try {
    await connection.beginTransaction();
    
    // 1. Crear la venta
    const [ventaResult] = await connection.execute(
      'INSERT INTO ventas (...) VALUES (...)',
      [...]
    );
    
    const ventaId = ventaResult.insertId;
    
    // 2. Si el pago es en EFECTIVO ‚Üí Actualizar caja autom√°ticamente
    if (metodo_pago === 'efectivo') {
      // Obtener monto actual de caja
      const [cajaRows] = await connection.execute(
        'SELECT monto_actual FROM caja WHERE sucursal = ?',
        [sucursal]
      );
      
      const montoAnterior = cajaRows[0]?.monto_actual || 0;
      const montoNuevo = montoAnterior + total;
      
      // Actualizar caja
      await connection.execute(
        'UPDATE caja SET monto_actual = ? WHERE sucursal = ?',
        [montoNuevo, sucursal]
      );
      
      // Registrar movimiento
      await connection.execute(`
        INSERT INTO movimientos_caja 
        (sucursal, tipo_movimiento, monto, monto_anterior, monto_nuevo, concepto, venta_id, usuario_email) 
        VALUES (?, 'ingreso_venta', ?, ?, ?, ?, ?, ?)
      `, [
        sucursal,
        total,
        montoAnterior,
        montoNuevo,
        `Venta #${numero_venta}`,
        ventaId,
        (req as any).user?.email
      ]);
    }
    
    await connection.commit();
    res.json({ success: true });
    
  } catch (error) {
    await connection.rollback();
    throw error;
  } finally {
    connection.release();
  }
};
```

---

### üíº P√ÅGINA: GESTI√ìN DE CAJA (`/finance/cash`)

**Archivo**: `src/pages/finance/Cash.tsx`

#### Funcionalidades:

**Para USUARIOS NORMALES** (modo lectura):
- ‚úÖ Ver monto actual de SU sucursal
- ‚úÖ Ver historial de movimientos
- ‚ùå NO pueden ajustar montos
- ‚ùå NO pueden ver otras sucursales

**Para ADMINISTRADORES**:
- ‚úÖ Ver monto de TODAS las sucursales
- ‚úÖ Ajustar monto manualmente de cualquier sucursal
- ‚úÖ Registrar env√≠os de dinero
- ‚úÖ Ver historial completo con filtros

#### C√≥digo de Ejemplo:

```typescript
const Cash: React.FC = () => {
  const { usuario } = useAuth();
  const esAdmin = usuario?.esAdmin;
  const sucursalUsuario = obtenerSucursalDelUsuario(usuario?.email);
  
  const [cajas, setCajas] = useState<Caja[]>([]);
  
  // Cargar cajas seg√∫n permisos
  const cargarCajas = async () => {
    try {
      const data = await cajaService.obtenerTodasLasCajas();
      
      // Filtrar seg√∫n permisos
      if (esAdmin) {
        setCajas(data); // Admin ve todas
      } else {
        // Usuario normal ve solo su sucursal
        setCajas(data.filter(c => c.sucursal.toLowerCase() === sucursalUsuario));
      }
    } catch (error) {
      message.error('Error al cargar cajas');
    }
  };
  
  // Ajustar monto (SOLO ADMIN)
  const handleAjustarMonto = async (sucursal: string, nuevoMonto: number, concepto: string) => {
    if (!esAdmin) {
      message.error('No tienes permisos para ajustar el monto');
      return;
    }
    
    try {
      await cajaService.ajustarCaja(sucursal, nuevoMonto, concepto);
      message.success('Monto ajustado exitosamente');
      cargarCajas();
    } catch (error) {
      message.error('Error al ajustar monto');
    }
  };
  
  // Registrar env√≠o de dinero
  const handleEnvio = async (sucursal: string, monto: number, concepto: string) => {
    try {
      await cajaService.registrarEnvio(sucursal, monto, concepto);
      message.success('Env√≠o registrado exitosamente');
      cargarCajas();
    } catch (error) {
      message.error('Error al registrar env√≠o');
    }
  };
  
  return (
    <div>
      {/* Mostrar cajas seg√∫n tama√±o (1 grande para usuario, grid para admin) */}
      <Row gutter={[16, 16]}>
        {cajas.map(caja => (
          <Col 
            key={caja.sucursal} 
            xs={24} 
            sm={esAdmin ? 12 : 24} 
            md={esAdmin ? 8 : 24}
          >
            <Card>
              <Statistic
                title={caja.sucursal.toUpperCase()}
                value={caja.monto_actual}
                precision={2}
                prefix="$"
              />
              
              {esAdmin && (
                <Space>
                  <Button onClick={() => showAjustarModal(caja.sucursal)}>
                    Ajustar Monto
                  </Button>
                  <Button onClick={() => showEnvioModal(caja.sucursal)}>
                    Enviar Dinero
                  </Button>
                </Space>
              )}
            </Card>
          </Col>
        ))}
      </Row>
      
      {/* Historial de movimientos */}
      <Button onClick={() => setHistorialVisible(true)}>
        Ver Historial de Movimientos
      </Button>
    </div>
  );
};
```

---

### üîê PERMISOS Y SEGURIDAD

**Backend**: `api/routes/caja.ts`

```typescript
import express from 'express';
import { verificarAutenticacion, verificarAdmin } from '../middleware/auth.js';
import { 
  obtenerCaja, 
  obtenerTodasLasCajas, 
  ajustarCaja, 
  registrarEnvio,
  obtenerMovimientos 
} from '../controllers/cajaController.js';

const router = express.Router();

// Todas las rutas requieren autenticaci√≥n
router.use(verificarAutenticacion);

// Obtener todas las cajas (admin ve todas, usuario normal solo la suya)
router.get('/', obtenerTodasLasCajas);

// Obtener caja espec√≠fica
router.get('/:sucursal', obtenerCaja);

// Historial de movimientos (con filtros)
router.get('/movimientos/historial', obtenerMovimientos);

// Ajustar monto (SOLO ADMIN)
router.put('/:sucursal/ajustar', verificarAdmin, ajustarCaja);

// Registrar env√≠o (todos pueden enviar dinero de su sucursal)
router.post('/envio', registrarEnvio);

export default router;
```

---

### ‚ö†Ô∏è REGLAS DEL SISTEMA DE CAJA

#### ‚ùå NUNCA HACER:
1. **NO** permitir ajustes manuales a usuarios normales
2. **NO** permitir montos negativos
3. **NO** olvidar registrar CADA movimiento
4. **NO** hacer actualizaciones sin transacciones

#### ‚úÖ SIEMPRE HACER:
1. **SIEMPRE** usar transacciones para actualizaciones de caja
2. **SIEMPRE** registrar en `movimientos_caja`
3. **SIEMPRE** guardar `monto_anterior` y `monto_nuevo`
4. **SIEMPRE** validar permisos (admin vs usuario normal)
5. **SIEMPRE** incluir concepto descriptivo

---

### üìä TIPOS DE MOVIMIENTOS

| Tipo | Descripci√≥n | Qui√©n puede hacer | Autom√°tico/Manual |
|------|-------------|-------------------|-------------------|
| `ingreso_venta` | Venta en efectivo | Sistema (POS) | ‚úÖ Autom√°tico |
| `ingreso_cuenta_corriente` | Pago de CC en efectivo | Sistema | ‚úÖ Autom√°tico |
| `envio` | Env√≠o de dinero | Todos (su sucursal) | ‚öôÔ∏è Manual |
| `ajuste_manual` | Ajuste manual | SOLO Admin | ‚öôÔ∏è Manual |

---

### üìà HISTORIAL DE MOVIMIENTOS

**Modal con Filtros**:
- ‚úÖ Filtrar por fecha (desde - hasta)
- ‚úÖ Filtrar por sucursal
- ‚úÖ Filtrar por tipo de movimiento
- ‚úÖ Ver detalles completos (usuario, concepto, montos)

**Tabla de Historial**:
```typescript
<Table
  columns={[
    { title: 'Fecha', dataIndex: 'created_at' },
    { title: 'Sucursal', dataIndex: 'sucursal' },
    { title: 'Tipo', dataIndex: 'tipo_movimiento' },
    { title: 'Monto', dataIndex: 'monto', render: (val) => `$${val}` },
    { title: 'Monto Anterior', dataIndex: 'monto_anterior' },
    { title: 'Monto Nuevo', dataIndex: 'monto_nuevo' },
    { title: 'Concepto', dataIndex: 'concepto' },
    { title: 'Usuario', dataIndex: 'usuario_email' }
  ]}
  dataSource={movimientos}
/>
```

---

## üìö DOCUMENTACI√ìN ADICIONAL ACTUALIZADA

Archivos de documentaci√≥n incluidos en el proyecto:

- `CONTEXTO_AGENTE.md` ‚Üí Contexto completo para el agente IA (OBSOLETO, usar `.cursorrules`)
- `COMO_FUNCIONA_PRODUCTOS_EXPLICACION_VISUAL.md` ‚Üí C√≥mo funciona el sistema de productos
- `ANALISIS_ESTRUCTURA_PRODUCTOS_Y_STOCK.md` ‚Üí An√°lisis de la base de datos
- `README.md` ‚Üí Documentaci√≥n general del proyecto
- **`SOLUCION_ENCODING_UTF8.md`** ‚Üí ‚≠ê Soluci√≥n completa de encoding UTF-8
- **`AUDITORIA_ENCODING_COMPLETA.md`** ‚Üí ‚≠ê Reporte de auditor√≠a (32 tablas, 155 campos)
- **`SOLUCION_PROBLEMAS_LOGIN.md`** ‚Üí Troubleshooting de problemas de login y ports

---

## üìä ESTRUCTURA COMPLETA DE BASE DE DATOS (ACTUALIZADA)

### Tablas de Clientes (Din√°micas):
```
clientes_pando
clientes_maldonado
clientes_rivera
clientes_melo
clientes_paysandu
clientes_salto
clientes_tacuarembo
clientes_rionegro
clientes_sanisidro
clientes_soriano
... (se crean din√°micamente)
```

### Tablas de Productos:
```
productos                  # Cat√°logo maestro
productos_sucursal         # Stock y precios por sucursal
categorias_productos       # Tipos, marcas, calidades
```

### Tablas de Ventas:
```
ventas                     # Ventas principales
ventas_detalle             # L√≠neas de productos vendidos
ventas_diarias_resumen     # Res√∫menes agregados por d√≠a
```

### Tablas de Caja (‚≠ê NUEVO):
```
caja                       # Saldo actual por sucursal
movimientos_caja           # Historial de todos los movimientos
```

### Tablas de Cuenta Corriente:
```
cuenta_corriente_movimientos    # Movimientos de CC
pagos_cuenta_corriente          # Pagos realizados
resumen_cuenta_corriente        # Resumen por cliente
```

### Tablas de Comisiones:
```
comisiones_vendedores           # Comisiones generadas
comisiones_por_vendedor         # Configuraci√≥n por vendedor
configuracion_comisiones        # Configuraci√≥n global
historial_cambios_comisiones    # Auditor√≠a de cambios
historial_pagos_comisiones      # Pagos de comisiones
remanentes_comisiones           # Remanentes acumulados
```

### Tablas de Staff:
```
vendedores                      # Vendedores/usuarios
configuracion_sucursales        # Configuraci√≥n de sucursales
```

### Tablas de Transferencias:
```
transferencias                  # Transferencias entre sucursales
transferencias_detalle          # Detalle de productos transferidos
historial_transferencias        # Historial completo
```

### Tablas de Sistema:
```
secuencias                      # Secuencias para n√∫meros de venta
```

**TOTAL**: 32+ tablas (din√°micas por sucursales)

---

## üéØ RESUMEN DE REGLAS (ACTUALIZADO)

1. ‚úÖ **Base de Datos**: localhost:3307, zarparDataBase, NUNCA cambiar
2. ‚úÖ **Revisar C√≥digo**: SIEMPRE antes de cambiar, NO romper nada
3. ‚úÖ **Espa√±ol**: Todo en espa√±ol, comentarios, mensajes, UI
4. ‚úÖ **Ense√±ar**: Usuario principiante, explicar TODO con ejemplos
5. ‚úÖ **Sucursales**: Sistema din√°mico, "Administrador" NO es sucursal
6. ‚úÖ **Optimizar BD**: Evitar tablas innecesarias, agregar columnas primero
7. ‚úÖ **Explicar**: Ense√±ar el "por qu√©" y "c√≥mo" con analog√≠as
8. ‚úÖ **Sin Bugs**: Revisar TODO, prevenir problemas, solucionar BIEN
9. ‚úÖ **UI Profesional**: 100% responsive, iconos, animaciones, hover
10. ‚úÖ **Seguridad**: Prepared statements, validaci√≥n, sanitizaci√≥n
11. ‚úÖ **Eliminaci√≥n Inteligente**: Hard delete con fallback a soft delete
12. ‚úÖ **Sistema Din√°mico**: Sucursales 100% escalables
13. ‚úÖ **Encoding UTF-8**: Configuraci√≥n correcta en TODA la cadena (‚≠ê CR√çTICO)
14. ‚úÖ **PDFs Profesionales**: Dise√±o elegante, datos ordenados, encoding correcto
15. ‚úÖ **Sistema de Caja**: Control total del efectivo, historial completo

---

## üöÄ TECNOLOG√çAS DEL PROYECTO (ACTUALIZADO)

- **Frontend**: React 18 + TypeScript + Vite + Ant Design 5
- **Backend**: Node.js + Express + TypeScript
- **Base de Datos**: MySQL 8.0 (Docker) con **utf8mb4**
- **PDFs**: jsPDF + jspdf-autotable
- **Autenticaci√≥n**: JWT + bcryptjs
- **Puertos**: Frontend:5678, Backend:3456, MySQL:3307

---

## üìÑ CHANGELOG

### **Versi√≥n 3.0.0 - 5 de Noviembre, 2025 (Actualizaci√≥n Cr√≠tica)**
- ‚úÖ **ENCODING UTF-8 COMPLETO Y AUDITADO** (‚≠ê CR√çTICO)
  - Configuraci√≥n obligatoria en pool MySQL
  - Scripts de correcci√≥n para 32 tablas
  - Auditor√≠a completa de 155 campos VARCHAR/TEXT
  - 70+ registros corruptos corregidos
  - Documentaci√≥n exhaustiva (2 archivos MD)
- ‚úÖ **SISTEMA DE GENERACI√ìN DE PDFs PROFESIONALES**
  - jsPDF + autoTable configurados
  - Ordenamiento inteligente de datos
  - Dise√±o profesional con header/footer
  - Encoding UTF-8 correcto en PDFs
  - P√°gina `/products/prices` completamente funcional
- ‚úÖ **SISTEMA DE GESTI√ìN DE CAJA**
  - 2 nuevas tablas: `caja`, `movimientos_caja`
  - Integraci√≥n autom√°tica con ventas en efectivo
  - Integraci√≥n con pagos de cuenta corriente
  - Historial completo de movimientos
  - Permisos diferenciados (admin vs usuario)
  - P√°gina `/finance/cash` completamente funcional
- ‚úÖ **LIMPIEZA DE DATOS**
  - Modal de limpieza selectiva por m√≥dulos
  - Borrado seguro con transacciones
  - Correcci√≥n de bugs en eliminaci√≥n de ventas
- ‚úÖ **MIGRACI√ìN DE REPORTES**
  - Bot√≥n "VENTAS GLOBALES" migrado a `/inventory/log`
  - Preparado para 4 reportes adicionales
- ‚úÖ **DOCUMENTACI√ìN COMPLETA**
  - `SOLUCION_ENCODING_UTF8.md`
  - `AUDITORIA_ENCODING_COMPLETA.md`
  - `SOLUCION_PROBLEMAS_LOGIN.md`
  - Scripts de auditor√≠a y correcci√≥n

### Versi√≥n 2.1.0 - 31 de Octubre, 2025 (Actualizaci√≥n Mayor)
- ‚úÖ **SISTEMA DIN√ÅMICO Y ESCALABLE DE SUCURSALES**
- ‚úÖ M√≥dulo de utilidades `api/utils/database.ts` con funciones helpers
- ‚úÖ Autenticaci√≥n din√°mica - Admin accede a TODAS las sucursales autom√°ticamente
- ‚úÖ Frontend de Productos carga sucursales din√°micamente
- ‚úÖ Eliminadas TODAS las listas hardcodeadas de sucursales
- ‚úÖ Cualquier nueva sucursal tiene TODAS las funcionalidades autom√°ticamente
- ‚úÖ Sistema robusto de eliminaci√≥n de sucursales con limpieza completa
- ‚úÖ Documentaci√≥n completa de la soluci√≥n din√°mica

### Versi√≥n 2.0.0 - 31 de Octubre, 2025
- ‚úÖ Implementado sistema de eliminaci√≥n inteligente de vendedores
- ‚úÖ Hard delete con fallback a soft delete por Foreign Keys
- ‚úÖ UI mejorada con advertencias visuales fuertes
- ‚úÖ Mensajes descriptivos seg√∫n tipo de eliminaci√≥n
- ‚úÖ An√°lisis completo de Foreign Key Constraints
- ‚úÖ Documentaci√≥n actualizada (CHANGELOG.md)
- ‚úÖ Backup completo de base de datos

### Versi√≥n 1.0.0 - 28 de Octubre, 2025
- ‚úÖ Sistema base de sucursales y vendedores
- ‚úÖ Autenticaci√≥n JWT
- ‚úÖ Permisos por rol (admin vs sucursal)
- ‚úÖ Docker MySQL configurado
- ‚úÖ Frontend React + TypeScript + Ant Design
- ‚úÖ Backend Express + TypeScript

---

**√öltima actualizaci√≥n**: 5 de Noviembre, 2025  
**Versi√≥n**: 3.0.0  
**Estado**: ACTIVO - LEER SIEMPRE

---

## üéì FILOSOF√çA GENERAL DEL PROYECTO

Este proyecto est√° dise√±ado para ser:

1. **üìà ESCALABLE**: Agregar sucursales, productos, usuarios sin tocar c√≥digo
2. **üõ°Ô∏è ROBUSTO**: Manejo correcto de errores, transacciones, encoding
3. **üé® PROFESIONAL**: UI elegante, PDFs de calidad, feedback visual
4. **üîí SEGURO**: Prepared statements, validaci√≥n, permisos por rol
5. **üìö DOCUMENTADO**: C√≥digo comentado, archivos MD, changelog actualizado
6. **üåç INTERNACIONAL**: UTF-8 en toda la cadena, soporte para acentos
7. **üí° EDUCATIVO**: C√≥digo claro, comentarios explicativos, documentaci√≥n para principiantes

---

## ‚ö° TIPS PARA M√ÅXIMA ESCALABILIDAD

### ‚úÖ HACER:
1. **Carga din√°mica** de sucursales, productos, usuarios desde BD
2. **Validaci√≥n robusta** en backend y frontend
3. **Transacciones** para operaciones que modifican m√∫ltiples tablas
4. **Prepared statements** para TODAS las queries
5. **UTF-8** configurado en toda la cadena
6. **Permisos** verificados en backend, no solo en frontend
7. **Documentaci√≥n** actualizada con cada cambio importante

### ‚ùå NO HACER:
1. **Hardcodear** listas de sucursales, tipos, marcas
2. **Asumir** que los datos son correctos sin validar
3. **Mezclar** operaciones de BD sin transacciones
4. **Ignorar** warnings de encoding o linter
5. **Copiar** c√≥digo sin entender
6. **Dejar** console.log en producci√≥n sin raz√≥n
7. **Modificar** `.cursorrules` sin actualizar changelog
8. **Crear archivos MD** explicativos innecesarios (ver REGLA #16)

---

## üÜï REGLA #16: NO GENERAR ARCHIVOS .MD INNECESARIOS

### üéØ FILOSOF√çA: "Menos archivos, m√°s eficiencia"

**IMPORTANTE:** Para ahorrar tokens y evitar archivos innecesarios, NO crear archivos `.md` explicativos a menos que el usuario lo solicite expl√≠citamente.

#### ‚ùå NUNCA CREAR:
- `INSTRUCCIONES_*.md` (a menos que sea cr√≠tico para Railway)
- `README_*.md` (solo si es documentaci√≥n permanente)
- `GUIA_*.md` (explicar directamente al usuario)
- `SOLUCION_*.md` (documentar en commits y respuestas)

#### ‚úÖ ALTERNATIVAS:
1. **Explicar directamente** en la respuesta al usuario
2. **Documentar en commits** con mensajes detallados
3. **Agregar comentarios** en el c√≥digo
4. **Actualizar CHANGELOG.md** si es un cambio importante

#### üîπ EXCEPCIONES (s√≠ crear):
- Documentaci√≥n permanente del proyecto (ej: `README.md` principal)
- Migraciones cr√≠ticas de Railway que requieren instrucciones paso a paso
- Arquitectura o dise√±o que debe persistir

---

## üÜï REGLA #17: INFORMACI√ìN DE DESPLIEGUE - RAILWAY

### üöÄ DESPLIEGUE EN PRODUCCI√ìN

#### üìç **D√ìNDE EST√Å DESPLEGADO:**

**Plataforma:** Railway (https://railway.app)

**Repositorio GitHub:** https://github.com/chanchito2710/sistemaZarpar.git

**Branch Principal:** `Proyecto_depurado`

**Despliegue Autom√°tico:**
- ‚úÖ Cada `git push origin Proyecto_depurado` ‚Üí Railway redespliega autom√°ticamente
- ‚è±Ô∏è Tiempo de redeploy: 1-3 minutos
- üìä Logs en tiempo real: Panel de Railway

---

### üóÑÔ∏è BASE DE DATOS EN RAILWAY (MySQL)

#### **Acceso a la Base de Datos en Producci√≥n:**

**IMPORTANTE:** Railway tiene su propia instancia de MySQL separada del Docker local.

#### **M√âTODO 1: Railway Web Console (Recomendado)**

1. Ir a Railway Dashboard: https://railway.app
2. Seleccionar el proyecto "Sistema Zarpar"
3. Click en el servicio "MySQL"
4. Click en pesta√±a "Data"
5. Ejecutar SQL directamente en el navegador

#### **M√âTODO 2: MySQL Workbench (Conexi√≥n Externa)**

1. En Railway Dashboard ‚Üí MySQL ‚Üí Variables
2. Copiar credenciales:
   - `MYSQLHOST`
   - `MYSQLPORT`
   - `MYSQLUSER`
   - `MYSQLDATABASE`
   - `MYSQLPASSWORD`
3. Configurar conexi√≥n en MySQL Workbench con esos datos

#### **M√âTODO 3: CLI de Railway**

```bash
# Instalar Railway CLI
npm install -g @railway/cli

# Login
railway login

# Conectar al proyecto
railway link

# Acceder a MySQL
railway run mysql -u root -p
```

---

### üìù MODIFICAR BASE DE DATOS EN RAILWAY

#### **OPCI√ìN A: Migraciones Autom√°ticas (Preferido)**

1. Crear archivo de migraci√≥n en `database/migrations/XXX_descripcion.sql`
2. Hacer commit y push
3. Railway ejecuta migraciones autom√°ticamente al iniciar el servidor
4. Verificar en logs de Railway: `‚úÖ Migraci√≥n ejecutada: XXX_descripcion.sql`

**Sistema de Migraciones:**
- Ubicaci√≥n: `api/utils/migraciones.ts`
- Tabla de control: `migraciones` (registra cu√°les ya se ejecutaron)
- Ejecuta solo migraciones nuevas (evita duplicados)

#### **OPCI√ìN B: Ejecuci√≥n Manual SQL (Fallback)**

**Cuando usar:**
- Migraci√≥n autom√°tica falla
- Necesitas ejecutar SQL urgente
- Debugging en producci√≥n

**Pasos:**
1. Crear archivo SQL (ej: `EJECUTAR_EN_RAILWAY.sql`)
2. Documentar claramente qu√© hace
3. Acceder a Railway Web Console (Data tab)
4. Copiar y pegar SQL completo
5. Ejecutar y verificar resultados
6. Registrar manualmente en tabla `migraciones` si es necesario:
   ```sql
   INSERT INTO migraciones (nombre) VALUES ('nombre_migracion.sql');
   ```

#### **VERIFICAR CAMBIOS:**

```sql
-- Ver migraciones ejecutadas
SELECT * FROM migraciones ORDER BY ejecutado_en DESC;

-- Ver estructura de tabla
SHOW COLUMNS FROM nombre_tabla;

-- Verificar √≠ndices
SHOW INDEX FROM nombre_tabla;
```

---

### üîç DEBUGGING EN RAILWAY

#### **Ver Logs en Tiempo Real:**

1. Railway Dashboard ‚Üí Servicio ‚Üí Pesta√±a "Deployments"
2. Click en el deployment activo
3. Ver logs en tiempo real
4. Buscar errores o warnings

#### **Logs de Backend:**

```
[nodemon] starting `tsx api/server.ts`
üöÄ Servidor iniciado en http://localhost:3456
‚úÖ Conexi√≥n exitosa a MySQL
üì¶ Ejecutando migraciones...
‚úÖ Migraci√≥n ejecutada: 007_agregar_stock_minimo.sql
```

#### **Errores Comunes:**

1. **`ECONNREFUSED`** ‚Üí MySQL no est√° listo (esperar 30s)
2. **`ER_ACCESS_DENIED`** ‚Üí Credenciales incorrectas (verificar variables)
3. **`ER_NO_SUCH_TABLE`** ‚Üí Migraci√≥n no ejecutada (verificar tabla `migraciones`)

---

### ‚ö†Ô∏è IMPORTANTE: DIFERENCIAS LOCAL vs RAILWAY

| Aspecto | Local (Docker) | Railway (Producci√≥n) |
|---------|----------------|----------------------|
| **MySQL Port** | 3307 | Variable (env) |
| **API URL** | `http://localhost:3456/api` | Relativa `/api` |
| **CORS** | Permisivo | Estricto |
| **Migraciones** | Manual o auto | Solo auto |
| **Logs** | Terminal local | Dashboard Railway |
| **Acceso DB** | Docker exec | Web Console o CLI |

#### **API_URL Autom√°tico:**

El frontend detecta autom√°ticamente el entorno:

```typescript
const API_URL = import.meta.env.VITE_API_URL || 
  (window.location.hostname !== 'localhost' 
    ? '/api' 
    : 'http://localhost:3456/api');
```

**Local:** `http://localhost:3456/api`  
**Railway:** `/api` (relativo, evita CORS)

---

### üìã CHECKLIST: DEPLOY A RAILWAY

Antes de hacer push a `Proyecto_depurado`:

```
[ ] C√≥digo funciona en local
[ ] No hay errores de linter
[ ] Migraciones SQL est√°n en /database/migrations/
[ ] Commits tienen mensajes descriptivos
[ ] Se probaron todas las funcionalidades cr√≠ticas
[ ] Variables de entorno est√°n configuradas en Railway
```

**Despu√©s del push:**

```
[ ] Esperar 1-3 minutos (redeploy)
[ ] Verificar logs de Railway (sin errores)
[ ] Probar funcionalidad en la URL de producci√≥n
[ ] Abrir consola del navegador (F12) para debug
[ ] Verificar que migraciones se ejecutaron (si aplica)
```

---

üéØ **OBJETIVO FINAL**: Sistema de gesti√≥n empresarial completo, escalable, robusto y profesional para m√∫ltiples sucursales de venta de repuestos de celulares.
